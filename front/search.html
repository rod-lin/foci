<!-- search -->
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Pragma" content="no-cache">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

		<link rel="stylesheet" href="font/fontawesome/import.css">
		<link rel="stylesheet" href="font/ubuntu/import.css">
		<link rel="stylesheet" href="font/alegreya/import.css">

		<link rel="stylesheet" href="css/com.css">
		<link rel="stylesheet" href="css/search.css">

		<link rel="stylesheet" href="semantic/semantic.min.css">
		<script type="text/javascript" src="semantic/semantic.min.js"></script>
	</head>
	
	<body>
		<div id="search-result">
			<div id="search-result-search-box">
				<input id="search-result-search-box-input" class="search-result-search-box-input" />
			</div>
			<div id="search-result-cont">
				<!-- <div class="search-result-box">
					<div class="search-result-box-pic" style="background-image: url('img/deficon.jpg');"></div>
					<div class="search-result-box-cont">
						<span id="search-result-box-title" class="vcenter">Hello</span>
					</div>
				</div>
				<div class="search-result-box"></div>
				<div class="search-result-box"></div>
				<div class="search-result-box"></div>
				<div class="search-result-box"></div> -->
			</div>
		</div>

		<div id="search-main">
			<div id="search-main-box" class="vcenter" style="margin-top: -3%;">
				<!-- <div class="search-foci" style="font-size: 8em;">
					F<span class="fa fa-cog" style="font-size: 70%;"></span>ci
				</div> -->
				<!-- idea from https://tympanus.net/Development/SearchUIEffects/index8.html -->
				<div id="search-main-search-box" class="search-search-box">
					<input id="search-main-search-input" class="search-search-input" placeholder="Type for surprise" /><br>
					<!-- <div class="search-favtag">Tech</div> -->
				</div>
			</div>
		</div>

		<form id="search-favtag-add-form">
			<input class="search-input" placeholder="from" /><br>
			<input class="search-input" placeholder="to" />
		</form>

		<script src="lib/foci.js"></script>
		<script src="lib/vcent.js"></script>
		<script>
			"use strict";

			Array.prototype.choose = function () {
				return this[Math.floor(Math.random() * this.length)];
			};

			function jump(url) {
				window.location = url;
			};

			window.onload = function () {
				function genTag(tag, odd, id) {
					return '<div ' + (id ? "id='" + id + "'" : "") + ' class="search-favtag ' + (odd ? "search-favtag-odd" : "") + '">' + tag + '</div>';
				}

				function genResult(e) {
					return ' \
					<div class="search-result-box" onclick="jump(\'/test/event.html#' + e.euid + '\')"> \
						<div class="search-result-box-pic" style="background-image: url(\'' +
							(e.logo ? foci.download(e.logo) : "img/deficon.jpg")
							+ '\');"></div> \
						<div class="search-result-box-cont"> \
							<span id="search-result-box-title" class="vcenter">' + e.title + '</span> \
						</div> \
					</div>';
				}

				function pop(msg) {
					alert(msg);
				}

				function initResults(dat) {
					// alert(dat.length);
					$("#search-result-cont").html("");

					for (var i = 0; i < dat.length; i++) {
						$("#search-result-cont").append(genResult(dat[i]));
					}

					$("#search-main").addClass("search-main-hide");
				}

				function searchKeydown(e) {
					if (e.keyCode == 13) {
						search_query.kw = $(this).val();

						foci.get("/event/search", search_query, function (suc, dat) {
							if (suc) {
								$("#search-result-search-box-input").val(search_query.kw);
								search_query = { favtag: [] };
								initResults(dat);
							} else {
								pop(dat);
							}
						});
					}
				}

				var search_query = { favtag: [] };

				$("#search-main-search-input").keydown(searchKeydown);
				$("#search-main-search-input").focus();

				$("#search-result-search-box-input").keydown(searchKeydown);

				foci.get("/favtag", {}, function (suc, dat) {
					if (suc) {
						var i;

						for (i = 0; i < dat.length; i++) {
							$("#search-main-search-box").append(genTag(dat[i], i % 2));
						}

						$(".search-favtag").click(function () {
							if ($(this).hasClass("search-favtag-selected")) {
								var index = search_query.favtag.indexOf($(this).html());
								if (index != -1)
									search_query.favtag.splice(index, 1);
							} else {
								search_query.favtag.push($(this).html());
							}

							console.log(search_query);

							$(this).toggleClass("search-favtag-selected");
						});

						$("#search-main-search-box").append(genTag("<span id='search-favtag-add-icon' class='fa fa-plus'></span>", i % 2, "search-favtag-add"));

						var add_state = false; // closed
						var toggle_form = function () {
							$("#search-favtag-add-icon")
								.toggleClass("fa-plus")
								.toggleClass("fa-check");

							$("#search-favtag-add")
								.toggleClass("search-favtag-add-open");
							
							vcent.update();

							// to avoid event bubbling
							setTimeout(function () {
								add_state = !add_state;
								if (add_state) $("#search-favtag-add").unbind("click");
								else $("#search-favtag-add").click(toggle_form);
							}, 0);
						};
					
						$("#search-favtag-add-icon")
							.click(toggle_form);

						$("#search-favtag-add")
							.click(toggle_form)
							.append($("#search-favtag-add-form")[0]);

						vcent.update();
					} else {
						pop(dat);
					}
				});
			};
		</script>
	</body>
</html>
