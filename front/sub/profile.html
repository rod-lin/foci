<style>
	.column {
		background: black;
	}

	#sub-profile {
		height: 100%;
	}

	#sub-profile .left-bar {
		position: fixed;
		width: 20em;
		height: 100%;

		padding: 0 2rem;

		background: rgba(253, 253, 253, 0.7);
		border: 1px solid rgba(0, 0, 0, 0.1);
		border-width: 0 1px 0 0;

		text-align: center;

		overflow: auto;
	}

	#sub-profile .left-bar .avatar {
		display: inline-block;

		width: 9em;
		height: 9em;
		margin-top: 4em;

		border-radius: 50%;

		background-image: url("img/matt.jpg");

		background-repeat: no-repeat;
		background-size: cover;
		background-position: 50% 50%;

		box-shadow: 0 0 3px rgba(0, 0, 0, 0.3);
	}

	#sub-profile .left-bar .avatar.empty {
		background: rgba(0, 0, 0, 0.2);
	}

	#sub-profile .left-bar .dname {
		margin: 1rem 0 0 0;

		font-size: 2em;
		font-weight: bold;

		color: #262626;
	}

	#sub-profile .left-bar .rating {
		margin: 0.5rem 0 0 0;
	}

	#sub-profile .left-bar .descr {
		margin: 1rem 0 2rem 0;
		padding: 0 1rem;
		color: #999999;
	}

	#sub-profile .right-bar {
		position: relative;
		margin-left: 20em;
		height: 100%;
	}

	#sub-profile .right-bar.main-tab {
		height: 100%;
	}

	@media only screen and (max-width: 640px) {
		#sub-profile .left-bar {
			position: relative;
			height: auto;
			width: 100%;
			padding-bottom: 2rem;
			border-width: 0 0 1px 0;
		}

		#sub-profile .right-bar {
			margin-left: 0;
		}
	}
</style>

<div id="sub-profile">
	<div class="left-bar">
		<div class="avatar empty"></div>
		<div class="dname"></div>
		<div class="ui rating" data-max-rating="5"></div>
		<div class="descr"></div>
		<div class="ui horizontal divider">Some Data</div>
		<div class="ui grey statistic">
			<div class="value follows">
				--
			</div>
			<div class="label">
				Follows
			</div>
		</div>
		<div class="ui grey statistic">
			<div class="value followers">
				--
			</div>
			<div class="label">
				Followers
			</div>
		</div><br>
		<div class="ui grey statistic">
			<div class="value participated">
				--
			</div>
			<div class="label">
				Participated
			</div>
		</div>
	</div>
	<div class="right-bar">
		<div class="main-tab"></div>
		<!-- <div class="menu">
			<div class="item active partic-btn">Participating</div><div class="item org-btn">Organized</div>
		</div>
		<div class="tab">
			<div class="partic-event active"></div>
			<div class="org-event active"></div>
		</div> -->
	</div>

	<style>
		
		#sub-profile .new-event {
		}

		#sub-profile .new-event .ev-content {
			position: absolute;
			width: 70%;

			top: 0;
			left: 30%;

			border: 1px solid rgba(0, 0, 0, 0.1);
			border-width: 0 0 0 1px;
		}

		#sub-profile .new-event .ev-step {
			position: absolute;
			width: 30%;

			top: 0;
			left: 0;
		}

		#sub-profile .new-event .no-style {
			margin: 0;
			padding: 0;
			background: 0;
			outline: none;
			border: 0;
			resize: none;
			border-radius: 0;
		}

		#sub-profile .new-event .ev-title {
			width: 100%;
			padding: 2rem;
			background: white;
			color: #252525;

			font-size: 2em;
			font-weight: bold;

			border: 1px solid rgba(0, 0, 0, 0.1);
			border-width: 0 0 1px 0;
		}

		#sub-profile .new-event .ev-descr {
			width: 100%;
			padding: 2rem;
			background: white;
			color: #252525;

			min-height: 10em;

			font-size: 1.5em;
		}

		#sub-profile .new-event .ui.steps {
			border-width: 0 0 1px 0 !important;
			border-radius: 0 !important;
		}

		#sub-profile .new-event .ui.steps .step {
			border-radius: 0 !important;
		}

		#sub-profile .new-event .ev-content .page {
			display: none;
		}

		#sub-profile .new-event .ev-content .page.active {
			display: block;
		}

		#sub-profile .new-event .ev-content .warning {
			background: #FFF6F6;
			color: #9F3A38;
		}

		.ui.steps .step.active .title {
			color: rgba(0, 0, 0, .87) !important;
		}

		@media only screen and (max-width: 640px) {
			#sub-profile .new-event .ev-content {
				left: 20%;
				width: 80%;
			}

			#sub-profile .new-event .ev-step {
				width: 20%;
			}

			#sub-profile .new-event .ev-step .description {
				display: none;
			}

			#sub-profile .new-event .ev-title {
				padding: 1.4rem;
				font-size: 1.5em;
			}

			#sub-profile .new-event .ev-descr {
				padding: 1.4rem;
				font-size: 1.2em;
			}

			#sub-profile .new-event .ev-step .step {
				font-size: 0.7em;
			}

			#sub-profile .new-event .ev-step .step .icon {
				margin-bottom: 0.1em;
			}
		}

	</style>

	<div class="new-event-draft" style="display: none;">
		<div class="new-event">
			<div class="ev-step">
				<div class="ui vertical fluid steps"></div>
			</div>
			<div class="ev-content">
				<!-- <div id="sub-profile-map" class="map"></div> -->
				<div class="page page-info active">
					<input class="ev-title no-style" placeholder="Title">
					<textarea class="ev-descr no-style" placeholder="Description"></textarea>
				</div>
				<div class="page page-cover" style="text-align: center;"></div>
				<div class="page page-loc">
					<div class="map" style="height: 100%;"></div>
					<div style="text-align: center; position: absolute; top: 0; width: 100%; margin-top: 0.6rem; pointer-events: none;">
						<div class="ui compact black inline message loc-selected" style="min-width: 50%; max-width: 95%;"></div>
					</div>
				</div>
				<div class="page page-pub" style="text-align: center;">
					<div class="protocol">
						<style>
							
							#sub-profile .new-event .ev-content .page-pub .protocol {
								padding: 0 2rem;
								height: 100%;
							}

							#sub-profile .new-event .ev-content .page-pub .protocol .prompt {
								font-size: 2em;
								margin-bottom: 1rem;
								margin-top: -5rem;
							}

						</style>
						<div class="vcenter" style="display: inline-block;">
							<div class="prompt"></div>
							<div class="ui primary button publish-btn">Publish!</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
	function init(main, args, show, cont) {
		require([
			"com/env", "com/util", "com/event",
			"com/xfilt", "com/pages", "com/tab",
			"com/login", "com/event", "com/upload",
			"com/map", "com/lang"
		], function (env, util, event, xfilt, pages, tab, login, event, upload, map, lang) {
			var init = function (info, is_self) {
				var left_bar = main.find(".left-bar");
				var right_bar = main.find(".right-bar");

				var m = lang.msg;

				left_bar.find(".dname").html(util.fill());
				left_bar.find(".descr").html(util.fill());

				left_bar.find(".follows").html("--");
				left_bar.find(".followers").html("--");
				left_bar.find(".participated").html("--");

				left_bar.find(".rating").rating("disable").rating("set rating", 0);

				function setDom(info) {
					var avatar = info.avatar ? foci.download(info.avatar) : [ "img/matt.jpg", "img/stevie.jpg", "img/elliot.jpg" ].choose();
					var dname = info.dname ? xfilt(util.short(info.dname, 12)) : lang.msg("$front.sub.profile.anonymous");
					var descr = info.descr ? xfilt(util.short(info.descr, 128)) : lang.msg("($front.sub.profile.no_descr)");

					var rating = info.rating ? (info.rating[0] + info.rating[1]) / 2 : 0;

					left_bar.find(".rating").rating("set rating", 0);

					left_bar.find(".dname").html(dname);
					left_bar.find(".descr").html(descr);
					left_bar.find(".avatar").css("background-image", "url('" + avatar + "')").removeClass("empty");
				}

				var ev_list = {};

				function eventTabOnShow(name, enc, view, cb) {
					var next = function (suc) {
						ev_list[name].update();
						setTimeout(function () {
							updateAllPos(); // update pos after loading(because the scroll bar may appear)
							cb();
						}, 300);
					};

					updateAllPos();

					if (!ev_list[name]) {
						ev_list[name] = event.init(tb.getTab(name), {
							view: view,
							fetch: {
								fetch: function (skip, cb) {
									if (enc) {
										login.session(function (session) {
											foci.encop(session, { int: "event", action: name, skip: skip }, cb);
										});
									} else {
										foci.get("/user/" + name, { uuid: info.uuid, skip: skip }, cb);
									}
								},

								cont: cont,
								no_more_prompt: lang.msg("$front.sub.profile.no_more_result")
							}
						});
					}

					ev_list[name].clear(function () {
						ev_list[name].fetch(next);
					});
				}

				var tabs = {
					"partic": {
						name: lang.msg("$front.sub.profile.participated").capital(),
						onShow: function (show) {
							eventTabOnShow("partic", false, undefined, show);
						}
					},

					"org": {
						name: lang.msg("$front.sub.profile.organized").capital(),
						onShow: function (show) {
							eventTabOnShow("org", false, undefined, show);
						}
					}
				};

				var new_tab = main.children(".new-event-draft").children();

				new_tab.find(".ev-title").keyup(function () {
					$(this).removeClass("warning");
				});

				new_tab.find(".ev-descr").keyup(function () {
					$(this).removeClass("warning");
				});

				/*
					To add a step, you need to:
						1. Add a step item in the .ev-step
						2. Add a page in the .ev-content
						3. Add the step name in the "steps" array below
						4. Add check and show event in "step_show" and "step_check"
						5. Add initialization code in loadDraft
				 */
				
				"use strict";

				var loadDraft, clearDraft, hasDraft, saveDraft;
				var published;

				function initDraft() {
					var euid = null;
					// var steps = [ "info", "cover", "loc", "pub" ];
					var cur_step = "info";
					var bmap = null;
					var fields;

					var steps = {
						info: {
							title: "Info",
							icon: "info",
							subtitle: "Title and description",

							page: main.find(".page.page-info"),
							next: "cover",

							onInit: function (info) {
								fields.title = info.title ? info.title : "";
								fields.descr = info.descr ? info.descr : "";

								tb.getItem("new").html(lang.msg("$front.sub.profile.save").capital())
									.off("click", nextStep); // avoid duplication

								util.nextTick(function () { // avoid bubbling
									tb.getItem("new").on("click", nextStep);
								});

								// page 1
								new_tab.find(".ev-title").val(fields.title);
								new_tab.find(".ev-descr").val(fields.descr);

								return fields.title && fields.descr;
							},

							onCheck: function (cb) {
								var suc = true;

								if (!new_tab.find(".ev-title").val()) {
									new_tab.find(".ev-title").addClass("warning");
									suc = false;
								}

								if (!new_tab.find(".ev-descr").val()) {
									new_tab.find(".ev-descr").addClass("warning");
									suc = false;
								}

								if (suc) {
									uploadChanges({
										title: new_tab.find(".ev-title").val(),
										descr: new_tab.find(".ev-descr").val()
									}, function (suc) {
										if (suc) {
											new_tab.find(".info-step").addClass("completed");
											cb(true);
										} else {
											cb(false);
										}
									});
								} else cb(false);

								return;
							}
						},

						cover: {
							title: "Cover",
							icon: "camera retro card",
							subtitle: "Cover and logo",

							page: main.find(".page.page-cover"),
							next: "loc",

							onInit: function (info) {
								var event_tmp = event.eventTemplate();
								new_tab.find(".ev-content .page-cover").html(event_tmp);
								event_tmp
									.css("display", "inline-block")
									.css("text-align", "left")
									.css("max-width", "90%")
									.css("max-height", "90%")
									.addClass("vcenter");

								fields.cover = info.cover;

								event.setDom(event_tmp, {
									title: lang.msg("$front.sub.profile.template"),
									descr: lang.msg("$front.sub.profile.click_pic_to_change"),
									cover: info.cover
								}, {
									onCoverClick: function (dom) {
										upload.init(function (file) {
											if (file) {
												fields.cover = file;
												dom.changeCover(file);
											}
										});
									}
								});

								return fields.cover;
							},

							onCheck: function (cb) {
								if (fields.cover) {
									uploadChanges({
										cover: fields.cover
									}, function (suc) {
										if (suc) {
											new_tab.find(".cover-step").addClass("completed");
											cb(true);
										} else {
											cb(false);
										}
									});
								} else {
									util.ask(lang.msg("$front.sub.profile.no_selected($front.sub.profile.cover)$front.sub.profile.period $front.sub.profile.sure_to_leave?").capital(), function (suc) {
										if (suc) {
											// new_tab.find(".cover-step").addClass("completed");
											cb(true);
										} else {
											cb(false);
										}
									});
								}
							}
						},

						loc: {
							title: "Location",
							icon: "map outline",
							subtitle: "When and where",

							page: main.find(".page.page-loc"),
							next: "pub",

							onInit: function (info) {
								fields.lng = info.loclng;
								fields.lat = info.loclat;

								new_tab.find(".loc-selected").html("Select a location on the map");

								if (!bmap) {
									new_tab.find(".ev-content .page-loc .map").ready(function () {
										map.embed(new_tab.find(".ev-content .page-loc .map"), function (map) {
											bmap = map;

											// steps["loc"].onShow = function () {
											// 	bmap.init(); // init position

											// 	if (fields.lng && fields.lat)
											// 		bmap.set(fields.lng, fields.lat);
											// 	else
											// 		bmap.clear();
											// }

										}, {
											onClick: function (lng, lat, addr) { // called everytime a position is selected
												fields.lng = lng;
												fields.lat = lat;
												new_tab.find(".loc-selected").html(addr);
												// alert(lng + ", " + lat + ", " + addr);
											}
										});
									});
								}

								return fields.lng && fields.lat;
							},

							onCheck: function (cb) {
								if (fields.lng && fields.lat) {
									uploadChanges({
										loclng: fields.lng,
										loclat: fields.lat
									}, function (suc) {
										if (suc) {
											new_tab.find(".loc-step").addClass("completed");
											cb(true);
										} else {
											cb(false);
										}
									});
								} else {
									util.ask(lang.msg("$front.sub.profile.no_selected($front.sub.profile.location)$front.sub.profile.period $front.sub.profile.sure_to_leave?").capital(), function (suc) {
										if (suc) {
											// new_tab.find(".loc-step").addClass("completed");
											cb(true);
										} else {
											cb(false);
										}
									});
								}
							}
						},

						pub: {
							title: "Publish",
							icon: "send outline",
							subtitle: "Rules and protocols",

							page: main.find(".page.page-pub"),

							onInit: function (info) {
								// reset publish message
								setPublishMsg(lang.msg("$front.sub.profile.publish_event").capital());

								
								new_tab.find(".ev-content .protocol .publish-btn").removeClass("disabled");
								published = false;
								
								return false;
							}
						}
					};

					function setPublishMsg(msg) {
						new_tab.find(".ev-content .protocol .prompt").html(msg);
					}
					
					/* loader icon on the New/Save button */
					function setLoader() {
						tb.getItem("new").html("<div class='ui active inverted " + (
							display_mode == "normal"
							? "small" : "tiny"
						) + " inline loader'></div>");
					}

					function delLoader() {
						tb.getItem("new").html("Save");
					}

					// save the current changes
					function uploadChanges(changes, cb) {
						login.session(function (session) {
							setLoader();

							foci.encop(session, $.extend({
								int: "event",
								action: "setinfo",
								euid: euid
							}, changes), function (suc, dat) {
								delLoader();

								if (!suc) {
									util.emsg(dat);
								}

								cb(suc);
							});
						});
					}
					
					function checkStep(cb) {
						var check = steps[cur_step].onCheck;
						if (check) {
							check(cb);
						} else cb(true);
					}

					function setStep(step, nocheck) {
						var next = function (cast) {
							if (cast === false) return;

							// some settings to remove active page and cast to the new one
							new_tab.find(".ev-content .page.active").removeClass("active");
							new_tab.find(".ev-step .active").removeClass("active");
							new_tab.find("." + step + "-step").addClass("active");
							steps[step].page.addClass("active");

							cur_step = step;

							var show = steps[step].onShow;
							if (show) show();
						};

						if (nocheck) next();
						else checkStep(next);
					}

					// step initalize
					function initStep() {
						function set(select, page) {
							// alert("bond " + select + ", " + page);
							new_tab.find(select).on("click", function () {
								setStep(page);
							});
						}

						// init all step tags
						for (var k in steps) {
							if (steps.hasOwnProperty(k)) {
								var step = $(' \
									<div class="link step ' + k + '-step"> \
										<i class="' + steps[k].icon + ' icon"></i> \
										<div class="content"> \
											<div class="title">' + steps[k].title + '</div> \
											<div class="description">' + steps[k].subtitle + '</div> \
										</div> \
									</div> \
								');
								new_tab.find(".ev-step .steps").append(step);
								set(step, k);
							}
						}
					}

					function nextStep() {
						var next = steps[cur_step].next;

						if (next) {
							setStep(next);
						} else {
							checkStep(function () {});
						}
					}

					clearDraft = function () {
						euid = null;
						tb.getItem("new").off("click", nextStep);
						tb.getItem("new").html(lang.msg("$front.sub.profile.new").capital());
						// new_tab.find(".ev-step .step").off("click");
					};

					hasDraft = function () {
						return euid != null;
					};

					saveDraft = function (cb) {
						setLoader();
						checkStep(function (suc) {
							delLoader();
							cb(suc);
						});
					};

					loadDraft = function (info) {
						if (!info || !info.euid) {
							util.emsg("$impossible(euid not given)");
							return;
						} // make sure the event has been created

						updateNewEventPos(); // update position

						euid = info.euid;

						fields = {};
						var last = null;

						// init all steps with new event info
						for (var k in steps) {
							if (steps.hasOwnProperty(k)) {
								if (steps[k].onInit) {
									var finished = steps[k].onInit(info);
									if (finished) {
										new_tab.find("." + k + "-step").addClass("completed");
									} else {
										if (!last) last = k;
										new_tab.find("." + k + "-step").removeClass("completed");
									}
								}
							}
						}

						setStep(last || "pub", true);
					};

					initStep();

					// publish button onclick
					new_tab.find(".ev-content .protocol .publish-btn").click(function () {
						var btn = $(this);

						btn.addClass("loading");

						login.session(function (session) {
							foci.encop(session, {
								int: "event",
								action: "publish",
								euid: euid
							}, function (suc, dat) {
								btn.removeClass("loading");
								
								if (suc) {
									btn.addClass("disabled");
									published = true;
									setPublishMsg(lang.msg("$front.sub.profile.success! $front.sub.profile.you_can_go_tab_to_view($front.sub.profile.organized)").capital());
								} else {
									util.emsg(dat);
								}
							});
						});
					});
				};

				if (is_self) {
					initDraft();

					tabs["draft"] = {
						name: lang.msg("$front.sub.profile.draft").capital(),
						onShow: function (show) {
							eventTabOnShow("draft", true, function (info) {
								loadDraft(info);
								tb.to("new");
							}, show);
						}
					};

					tabs["new"] = {
						name: lang.msg("$front.sub.profile.new").capital(),
						float: "right",
						style: "green",

						onShow: function (show) {
							updateAllPos();

							login.session(function (session) {
								if (hasDraft()) {
									updateAllPos();
									show();
								} else {
									// alert("hi");
									foci.encop(session, {
										int: "event",
										action: "new"
									}, function (suc, dat) {
										if (suc) {
											loadDraft({ euid: dat });
											updateAllPos();
											show();
										} else {
											util.emsg(dat);
										}
									});
								}
							});
						},

						onChange: function (cb) {
							saveDraft(function (suc) {
								if (suc !== false) {
									clearDraft();
									if (!published)
										util.emsg("$front.sub.profile.save_draft", "info");
								}

								cb(suc); // if suc == true, change the tab
							});
							
							return false;
						}
					};
				}

				var tb = tab.init(right_bar.find(".main-tab"), tabs);

				if (is_self)
					tb.getTab("new").html(new_tab);

				tb.to("partic");

				var display_mode = "normal";

				function updateNewEventPos() {
					new_tab
						.find(".ev-descr")
						.css("height", tb.displayHeight() - new_tab.find(".ev-title").outerHeight() + "px");

					new_tab
						.find(".ev-content .page")
						.css("height", tb.displayHeight());
				}

				function updateAllPos() {
					if (!right_bar.offset().left) {
						display_mode = "mobile";
						right_bar.width(main.innerWidth());
						tb.flow(true);
					} else {
						display_mode = "normal";
						right_bar.width(main.innerWidth() - left_bar.outerWidth());
						tb.flow(false);
					}

					updateNewEventPos();
				}

				$(window).resize(function () {
					updateAllPos();
				});

				$(window).resize();

				setDom(info);

				show(true); // show part
			};

			if (args && args[0]) {
				var uuid = parseInt(args[0]);

				if (isNaN(uuid)) {
					util.emsg("$front.sub.profile.illegal_uuid");
					show(false);
				} else {
					foci.get("/user/info", { uuid: uuid }, function (suc, dat) {
						if (suc) {
							env.user(function (cur) {
								init(dat, cur && cur.uuid == dat.uuid);
							});
						} else {
							util.emsg(dat);
							show(false);
						}
					});
				}
			} else {
				if (!env.session()) {
					login.init(function (ses) {
						if (ses)
							env.user(function (info) { init(info, true); });
						else
							show(false);
					});
				} else {
					env.user(function (info) {
						if (info)
							init(info, true);
						else
							show(false);
					});
				}
			}
		});
	}
</script>
