<!-- main portal -->
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Pragma" content="no-cache">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

		<script src="lib/foci.js"></script>
		<script src="lib/vcent.js"></script>
		<script src="lib/require.js"></script>

		<link rel="stylesheet" href="font/fontawesome/import.css">
		<link rel="stylesheet" href="font/ubuntu/import.css">
		<link rel="stylesheet" href="font/alegreya/import.css">

		<link rel="stylesheet" href="/semantic/semantic.min.css">
		<script src="/semantic/semantic.min.js"></script>

		<!-- <link rel="stylesheet" href="com/tbar/import.css">
		<link rel="stylesheet" href="com/waterfall/import.css">
		<link rel="stylesheet" href="com/xfilt/import.css">
		<link rel="stylesheet" href="com/event/import.css"> -->

		<style>
			body {
				font-family: Ubuntu;
				line-height: normal;
				overflow: hidden;
			}

			#main {
				position: relative;
				height: 100%;
				width: 100%;
			}

			#search, #part {
				position: absolute;

				top: 0;
				left: 0;

				width: 100%;
				height: 100%;

				overflow: auto;
			}

			#cover {
				position: fixed;
				left: 0;
				top: 0;
				height: 100%;
				width: 100%;

				background-image: url("img/cover2.jpg");
				background-repeat: no-repeat;
				background-size: cover;
				background-position: 50% 50%;

				opacity: 1;

				transition: opacity 0.3s;
			}

			#cover .headline {
				font-size: 5em;
				margin-top: -1.5em;
				font-weight: bold;
				color: white;
				text-align: center;
			}

			#bottom-bar {
				padding-top: 1em;
				padding-bottom: 2em;
			}

			#result {
				text-align: center;
				color: #CCCCCC;
				font-weight: bold;
			}
		</style>
	</head>

	<body class="padding-tbar">
		<div id="main">
			<div id="search">
				<!-- <div class="header">
					<div class="ui breadcrumb" style="margin-top: 20px;">
						<div class="active section"></div>
					</div>
				</div> -->
				<div id="search-cont"></div>
				<div id="bottom-bar">
					<div id="loader" class="ui active centered inline loader" style="display: none;"></div>
					<div id="result" style="display: none;">no result</div>
				</div>
			</div>

			<div id="cover" style="opacity: 0;">
				<div class="ui active big loader"></div>
			</div>

			<div id="part"></div>
		</div>

		<!-- <div id="frame" style="height: 100px; width: 200px; background: white;"></div> -->

		<!-- <div class="frame", style="width: 100%; height: 100%; position: fixed; top: 0; left: 0; background: #FFF;"></div> -->

		<script>
			require([ "com/frame" ], function (frame) {
				// var fr = frame.init("#frame");
				// fr.open("main.html");
			});

			function jump(url) {
				window.location = url;
			}

			$("#cover").ready(function () {
				$("#cover>.loader").removeClass("active");
				$("#cover").css("opacity", "");
			});

			require([
				"com/tbar", "com/event", "com/env",
				"com/upload", "com/util", "com/pages",
				"com/parts"
			], function (tbar, event, env, upload, util, pages, parts) {
				env.init(function () {
					var bar = tbar.init();

					bar.menu(function () {
						if (!window.location.hash) {
							pg.toggle("cover", "search");
						} else {
							jump("#");
						}
					});

					bar.profile(function () {
						jump("#profile");
					});

					var pg = pages.init({
						"search": {
							page: "#search",
							onShow: function () {
								bar.delSimple();
							}
						},
						
						"cover": {
							page: "#cover",
							onShow: function () {
								bar.setSimple();
							}
						},

						"part": {
							page: "#part",
							onShow: function () {
								bar.delSimple();
							}
						},
					}, { init: "cover" });

					var ev = event.init("#search>#search-cont", {
						onUpdate: function (pos) {}
					});

					var orig = null;

					var pt = parts.init("#part", {
						onJump: function (notmain) {
							if (notmain) {
								orig = pg.cur();
								pg.to("part");
							} else {
								pg.to(orig || "cover");
							}
						}
					});

					/* test */
					// pt.load("profile");
					// bar.delSimple();
					// pg.to("part");
					/* test */

					function showLoader() {
						$("#loader").css("display", "");
					}

					function hideLoader() {
						$("#loader").css("display", "none");
					}

					function showResult(msg) {
						$("#result")
							.html(msg)
							.css("display", "");
					}

					function hideResult() {
						$("#result").css("display", "none");
					}

					var cur_count, maxn = 32;
					var cur_query;

					function search(query, clear, cb) {
						if (clear) cur_count = 0;

						if (!query) {
							if (cur_query) {
								query = cur_query;
							} else {
								cb(false);
								return;
							}
						} else cur_query = query;

						$.extend(query, { n: maxn, skip: cur_count });

						foci.get("/event/search", query, function (suc, dat) {
							if (suc) {
								cur_count += dat.length;
								for (var i = 0; i < dat.length; i++) ev.add(dat[i]);
								cb(dat.length != 0);
							} else {
								util.qmsg(dat);
								cb(false);
							}
						});
					}

					var no_refresh = false;

					util.scrollBottom("#search", 0, function (scroll) {
						if (no_refresh) return;
						showLoader();
						hideResult();

						scroll.toBottom();

						search(null, false, function (suc) {
							hideLoader();

							if (!suc) {
								showResult("no result");
								no_refresh = true;
							}
						});
					});

					bar.search(function (query, cb) {
						research(query, cb);
					});

					// re-search
					function research(query, cb) {
						hideResult();
						jump("#");
						orig = "search";
						pg.to("search");

						ev.clear(function () {
							$(window).scrollTop(0);
							ev.hide(function () {
								search(query, true, function (suc) {
									ev.show();

									if (!suc) {
										showResult("no result");
									}

									no_refresh = false;

									cb();
								});
							});
						});
					}
				});
			});
		</script>
	</body>
</html>
