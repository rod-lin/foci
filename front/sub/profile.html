<style>
	.column {
		background: black;
	}

	#sub-profile {
		height: 100%;
	}

	#sub-profile .left-bar {
		position: fixed;
		width: 20em;
		height: 100%;

		padding: 0 2rem;

		background: rgba(253, 253, 253, 0.7);
		border: 1px solid rgba(0, 0, 0, 0.1);
		border-width: 0 1px 0 0;

		text-align: center;

		overflow: auto;
	}

	#sub-profile .left-bar .avatar {
		display: inline-block;

		width: 9em;
		height: 9em;
		margin-top: 4em;

		border-radius: 50%;

		background-image: url("img/matt.jpg");

		background-repeat: no-repeat;
		background-size: cover;
		background-position: 50% 50%;

		box-shadow: 0 0 3px rgba(0, 0, 0, 0.3);
	}

	#sub-profile .left-bar .avatar.empty {
		background: rgba(0, 0, 0, 0.2);
	}

	#sub-profile .left-bar .dname {
		margin: 1rem 0 0 0;

		font-size: 2em;
		font-weight: bold;

		color: #262626;
	}

	#sub-profile .left-bar .rating {
		margin: 0.5rem 0 0 0;
	}

	#sub-profile .left-bar .descr {
		margin: 1rem 0 2rem 0;
		padding: 0 1rem;
		color: #999999;
	}

	#sub-profile .right-bar {
		position: relative;
		margin-left: 20em;
		height: 100%;
	}

	#sub-profile .right-bar .menu {
		width: 100%;
		background: rgba(253, 253, 253, 0.7);
		border: 1px solid rgba(0, 0, 0, 0.1);
		border-width: 0 0 1px 0;
	}

	#sub-profile .right-bar .menu .item {
		display: inline-block;

		padding: 1.5rem 2rem;
		border: 1px solid rgba(0, 0, 0, 0.1);
		border-width: 0 1px 0 0;

		color: #595959;
		cursor: pointer;

		transition: background 0.3s;
	}

	#sub-profile .right-bar .menu .item:hover {
		background: rgba(250, 250, 250, 1);
	}

	#sub-profile .right-bar .menu .item.active {
		background: rgba(248, 248, 248, 1);
	}

	#sub-profile .right-bar.main-tab {
		height: 100%;
	}

	@media only screen and (max-width: 640px) {
		#sub-profile .left-bar {
			position: relative;
			height: auto;
			width: 100%;
			padding-bottom: 2rem;
			border-width: 0 0 1px 0;
		}

		#sub-profile .right-bar {
			margin-left: 0;
		}
	}
</style>

<div id="sub-profile">
	<div class="left-bar">
		<div class="avatar empty"></div>
		<div class="dname"></div>
		<div class="ui rating" data-max-rating="5"></div>
		<div class="descr"></div>
		<div class="ui horizontal divider">Some Data</div>
		<div class="ui grey statistic">
			<div class="value follows">
				--
			</div>
			<div class="label">
				Follows
			</div>
		</div>
		<div class="ui grey statistic">
			<div class="value followers">
				--
			</div>
			<div class="label">
				Followers
			</div>
		</div><br>
		<div class="ui grey statistic">
			<div class="value participated">
				--
			</div>
			<div class="label">
				Participated
			</div>
		</div>
	</div>
	<div class="right-bar">
		<div class="main-tab"></div>
		<!-- <div class="menu">
			<div class="item active partic-btn">Participating</div><div class="item org-btn">Organized</div>
		</div>
		<div class="tab">
			<div class="partic-event active"></div>
			<div class="org-event active"></div>
		</div> -->
	</div>
</div>

<script>
	function init(main, args) {
		require([ "com/env", "com/util", "com/event", "com/xfilt", "com/pages", "com/tab", "com/login" ], function (env, util, event, xfilt, pages, tab, login) {
			var init = function (info) {
				var left_bar = main.find(".left-bar");
				var right_bar = main.find(".right-bar");

				left_bar.find(".dname").html(util.fill());
				left_bar.find(".descr").html(util.fill());

				left_bar.find(".follows").html("--");
				left_bar.find(".followers").html("--");
				left_bar.find(".participated").html("--");

				left_bar.find(".rating").rating("disable").rating("set rating", 0);

				function setDom(info) {
					var avatar = info.avatar ? foci.download(info.avatar) : [ "img/matt.jpg", "img/stevie.jpg", "img/elliot.jpg" ].choose();
					var dname = info.dname ? xfilt(util.short(info.dname, 12)) : "anonymous";
					var descr = info.descr ? xfilt(util.short(info.descr, 128)) : "(no description)";

					var rating = info.rating ? (info.rating[0] + info.rating[1]) / 2 : 0;

					left_bar.find(".rating").rating("set rating", 0);

					left_bar.find(".dname").html(dname);
					left_bar.find(".descr").html(descr);
					left_bar.find(".avatar").css("background-image", "url('" + avatar + "')").removeClass("empty");
				}

				function fetchEvent(url, ev, cb) {
					foci.get(url, { uuid: info.uuid }, function (suc, dat) {
						if (suc) {
							for (var i = 0; i < dat.length; i++) ev.add(dat[i]);
						} else {
							util.qmsg(dat);
						}

						cb();
					});
				}

				var partic_ev = null;
				var org_ev = null;

				var tb = tab.init(right_bar.find(".main-tab"), {
					"partic": {
						name: "Participated",
						onShow: function (show) {
							var next = function () {
								partic_ev.update();
								setTimeout(function () {
									show();
								}, 300);
							};

							if (!partic_ev) {
								partic_ev = event.init(tb.getTab("partic"));
								fetchEvent("/user/partic", partic_ev, next);
							} else {
								next();
							}
						}
					},

					"org": {
						name: "Organized",
						onShow: function (show) {
							var next = function () {
								org_ev.update();
								setTimeout(function () {
									show();
								}, 300);
							};

							if (!org_ev) {
								org_ev = event.init(tb.getTab("org"));
								fetchEvent("/user/org", org_ev, next);
							} else {
								next();
							}
						}
					}
				});

				$(window).resize(function () {
					if (right_bar.offset().left) {
						right_bar.width(main.innerWidth() - left_bar.outerWidth());
						tb.flow(false);
					} else {
						right_bar.width(main.innerWidth());
						tb.flow(true);
					}
				});

				$(window).resize();

				tb.to("partic");

				setDom(info);
			};

			if (args && args[0]) {
				var uuid = parseInt(args[0]);

				if (isNaN(uuid)) {
					util.qmsg("illegal uuid");
				} else {
					foci.get("/user/info", { uuid: uuid }, function (suc, dat) {
						if (suc) {
							init(dat);
						} else {
							util.qmsg(dat);
						}
					});
				}
			} else {
				if (!env.session()) {
					login.init(function () {
						env.user(function (info) { init(info); });
					});
				} else {
					env.user(function (info) { init(info); });
				}
			}
		});
	}
</script>
