<!-- user portal -->
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Pragma" content="no-cache">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

		<link rel="stylesheet" href="font/fontawesome/import.css">
		<link rel="stylesheet" href="font/ubuntu/import.css">

		<link rel="stylesheet" href="css/com.css">
		<link rel="stylesheet" href="css/port.css">
	</head>
	
	<body>
		<div id="port-main">
			<div id="port-header" class="port-header">
				<div id="port-icon" style="background-image: url('img/deficon.jpg');"></div>
				<div id="port-dname"></div>
				<div id="port-school-box">
					<span class="fa fa-map-marker"></span>
					<span id="port-school" style="margin-left: 0.3em;">
					</span>
				</div>
				<div id="port-intro"></div>
				<div id="port-button-set" class="avcenter">
					<span class="com-button com-button-green fa fa-plus-circle"></span>
				</div>
			</div>

			<div style="position: relative; text-align: center;">
				<div style="display: inline-block;">
					<div id="port-event-board">
						<div id="port-event-msg">no event</div>
					</div>
					<div id="port-toolbox-board">
						<div id="port-toolbox-1" class="port-toolbox">
							<span id="port-toolbox-1-add" class="port-add-event fa fa-plus-circle"></span>
							<div id="port-toolbox-1-form" style="display: none;">
								<style>
									.port-toolbox-1-input {
										margin: 0;
										border: 0;
										background: none;

										font-size: 1.4em;
										padding: 0.7em;
										margin-left: -0.7em;
										width: 100%;

										color: #191919;
										resize: none;

										font-family: Ubuntu;
									}

									.port-toolbox-1-split {
										width: 100%;
										height: 1px;
										background: #808080;
										box-shadow: 0 0 1px rgba(0, 0, 0, 0.2);
									}
								</style>
								<input id="port-toolbox-1-title" class="port-toolbox-1-input" placeholder="title">
								<div class="port-toolbox-1-split"></div>
								<textarea id="port-toolbox-1-descr" class="port-toolbox-1-input" placeholder="descr"></textarea>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div id="port-login" style="opacity: 0;">
				<div id="port-login-board" class="vcenter">
					<div id="port-tbar">
						<span id="port-title" class="vcenter" style="font-size: 1.2em;">Login</span>
					</div>

					<div id="port-cont" style="text-align: center;">
						<div class="vcenter">
							<input id="port-uname" class="com-input" style="text-align: center; width: 60%; margin-top: 3em;" placeholder="user name" />
							<input id="port-passwd" class="com-input" style="text-align: center; width: 60%; margin-top: 0.5em;" placeholder="password" type="password" /><br>
							<span id="port-create" class="com-button com-button-green" style="width: 5em; margin-top: 1em;">go</span>
						</div>
					</div>
				</div>
			</div>
		</div>

		<script src="fcauth.js"></script>
		<script src="vcent.js"></script>
		<script>
			Array.prototype.choose = function () {
				return this[Math.floor(Math.random() * this.length)];
			};
		</script>
		<script>
			"use strict";

			window.onload = function () {
				var color_boxa = [ "#1ABC9C", "#2ECC71", "#3498DB", "#9B59B6", "#E67E22", "#E74C3C" ];
				var color_boxb = [ "#16A085", "#27AE60", "#2980B9", "#8E44AD", "#D35400", "#C0392B" ];

				var title = function (msg) {
					$("#port-title").html(msg);
				};

				var setred = function (e) {
					e.addClass("com-input-red");
				};

				var nored = function (e) {
					e.removeClass("com-input-red");
				};

				var hideLogin = function () {
					$("#port-login").css("opacity", "0");
					setTimeout(function () {
						$("#port-login").css("display", "none");
					}, 500);
				};

				var def = function (str, def) {
					return str.length ? str : def;
				};

				var loadInfo = function () {
					FCAuth.encop(gsession, {
						int: "info",
						action: "get"
					}, function (suc, dat) {
						if (suc) {
							$("#port-dname").html(dat.dname);
							$("#port-intro").html(def(dat.intro, "no intro"));
							$("#port-school").html(def(dat.school, "no school"));
						} else {
							$("#port-dname").html("loading failed: " + dat);
						}
					});

					FCAuth.get("/user/org", { uuid: gsession.getUUID() }, function (suc, dat) {
						if (suc) {
							if (!dat.length) {
								showEventMsg("no event");
							} else {
								dat.forEach(function (ev) {
									$("#port-event-board").append(formatEvent(ev));
								});
							}
						} else {
							showEventMsg("loading failed: " + dat);
						}
					});
				};

				var formatTime = function (start, end) {
					var ret = "";
					var form = function (date) {
						return date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + date.getDate();
					};

					if (start) {
						ret += form(new Date(start));
					} else {
						ret += "TBD"
					}

					ret += " ~ ";

					if (end) {
						ret += form(new Date(end));
					} else {
						ret += "TBD"
					}

					return ret;
				};

				var formatEvent = function (info) {
					return '<div class="port-event"> \
						<div class="port-event-tbar" style="background: ' + color_boxb.choose() + ';"> \
							<div class="vcenter"> \
								<span class="port-event-title">' + (info.title || "no title") + '</span><br><br> \
								<span class="fa fa-map-pin" style="margin-right: 0.5em; font-size: 80%;"></span> \
								<span style="font-size: 80%;">' + (info.location || "TBD") + '</span><br> \
								<span class="fa fa-clock-o" style="margin-right: 0.5em; font-size: 80%;"></span> \
								<span style="font-size: 80%;">' + formatTime(info.start, info.end) + '</span> \
							</div> \
						</div> \
						<div class="port-event-cont">' + (info.descr ? info.descr.replace("\n", "<br>") : "no description") + '</div> \
					</div><br>';
				};

				var showEventMsg = function (msg) {
					$("#port-event-msg").html(msg);
					$("#port-event-msg").css("display", "");
				};

				var hideEventMsg = function () {
					$("#port-event-msg").css("display", "nonde");
				};

				$("#port-uname").keydown(function () { console.log("hi"); nored($(this)); });
				$("#port-passwd").keydown(function () { nored($(this)); });

				var gsession = null;

				FCAuth.qlogin(function (suc, dat) {
					if (suc) {
						gsession = dat;
						hideLogin();
						loadInfo();
					} else {
						$("#port-login").css("opacity", "1");
					}
				});

				$("#port-create").click(function () {
					// var orig = $("#port-create").html();

					var uname = $("#port-uname").val();
					var passwd = $("#port-passwd").val();
					var err = false;

					if (!uname) {
						setred($("#port-uname"));
						err = true;
					}

					if (!passwd) {
						setred($("#port-passwd"));
						err = true;
					}

					if (err) return;

					$("#port-create").html("<span class='fa fa-cog fa-spin'></span>");

					FCAuth.login(uname, passwd, function (suc, dat) {
						setTimeout(function () {
							if (suc) {
								gsession = dat;
								$("#port-create").html("<span class='fa fa-check'></span>");
								setTimeout(function () {
									hideLogin();
									loadInfo();
								}, 500);
							} else {
								$("#port-create").html("go");
								title(dat);
								setTimeout(function () {
									title("Login");
								}, 3000);
							}
						}, 500);
					});
				});

				$("#port-toolbox-1-add").click(function () {
					$("#port-toolbox-1-add").css("display", "none");
					$("#port-toolbox-1-form").css("display", "");
				});
			};
		</script>
	</body>
</html>
