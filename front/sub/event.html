<div id="sub-event">
	<div class="cont">
		<!-- <div class="tcover"></div> -->
		<div class="cont-box">
			<div class="box">
				<div class="scover"></div>
				<div class="info-box">
					<div class="title"></div>
					<div class="location"><i class="map outline icon"></i><span></span></div>
					<div class="date"><i class="calendar outline icon"></i><span></span></div>
					<div class="descr"></div>
				</div>
			</div>
			<div class="box pad" style="margin-top: 1rem;">
				<div class="sub-title">Detail</div>
				<div class="detail" style="margin-top: 1rem; text-align: left;">
					<img class="com-util-cont-fill" src="img/paragraph.png"></img>
				</div>
			</div>
			<div class="box" style="margin-top: 1rem; overflow: hidden;">
				<div class="blurring dimmable bmap-box">
					<div class="ui dimmer">
						<div class="content">
							<div class="center">
								<div class="ui inverted button view-btn">View</div>
							</div>
						</div>
					</div>
					<div class="bmap"></div>
				</div>
			</div>

			<style>
				
				#sub-event .cont .row {}

				#sub-event .cont .col {
					display: inline-block;
					vertical-align: top;
					padding-right: 0.5rem;
					margin-top: 1rem;
				}

				#sub-event .cont .col:last-child {
					padding-right: 0;
					padding-left: 0.5rem;
				}

				#sub-event .cont .col-7 {
					width: 70%;
				}

				#sub-event .cont .col-3 {
					width: 30%;
				}

				@media only screen and (max-width: 720px) {
					#sub-event .cont .col-mid-full {
						padding: 0 !important;
						width: 100%;
					}
				}

				.ui.active.loader+span {
					opacity: 0;
				}

			</style>

			<div class="row">
				<div class="col col-7 col-mid-full">
					<div class="box pad">
						<div class="sub-title">Organizers</div>
						<div class="org" style="margin-top: 1rem;">
							<img class="com-util-cont-fill" src="img/paragraph.png"></img>
							<img class="com-util-cont-fill" src="img/paragraph.png"></img>
							<img class="com-util-cont-fill" src="img/paragraph.png"></img>
						</div>
					</div>
				</div><div class="col col-3 col-mid-full box-set">
					<div class="box pad">
						<div class="apply-prompt">Apply for</div>
					</div>
					<div class="box pad apply-appcent btn" style=" margin-top: 0.2rem; background: #34495E; color: white; display: none;">
						<div class="ui inverted loader"></div>
						<span>Application center</span>
					</div>
					<div class="box pad apply-staff btn" style=" margin-top: 0.2rem; background: #3498DB; color: white;">
						<div class="ui inverted loader"></div>
						<span>Staff</span>
					</div>
					<div class="box pad apply-partic btn" style="margin-top: 0.2rem; background: #2ECC71; color: white;">
						<div class="ui inverted loader"></div>
						<span>Participant</span>
					</div>
				</div>
			</div>

			<div style="overflow: hidden; padding: 0 5% 3px 5%; width: 110%; margin-left: -5%;">
				<div class="box pad" style="margin-top: 1rem; width: 100%;">
					<div class="sub-title">Comments</div>
					<div class="comment">
						<img class="com-util-cont-fill" src="img/paragraph.png"></img>
						<img class="com-util-cont-fill" src="img/paragraph.png"></img>
						<img class="com-util-cont-fill" src="img/paragraph.png"></img>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="ui large loader active"></div>
	<div class="cover">
		<div class="left-corner shadow"></div>
		<div class="left-corner">
			<div class="date"><i class="calendar icon"></i><span>loading</span></div>
			<div class="location"><i class="map icon"></i><span>loading</span></div>
			<div class="title">(untitled)</div>
			<div class="tip">Click for more</div>
		</div>
		<!-- <div class="ui loader active"></div> -->
	</div>
</div>

<style>
	#sub-event {
		height: 100%;
	}

	#sub-event .cover {
		position: fixed;

		height: 100%;
		width: 100%;
		top: 0;

		background-repeat: no-repeat;
		background-size: cover;
		background-position: 50% 50%;
		
		overflow: hidden;

		box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);

		transition: top 0.7s cubic-bezier(0.19, 1, 0.22, 1);
	}

	#sub-event .cover.hide {
		top: -100%;
	}

	#sub-event .cover .dim {
		height: 100%;
		width: 50%;

		background-image: url("img/cover3.jpg");
		background-repeat: no-repeat;
		background-size: cover;
		background-position: 50% 50%;
		transition: opacity 0.5s;
	}

	#sub-event .cover .cont {
		height: 100%;
		width: 100%;
	}

	#sub-event .cover .left-corner.shadow {
		position: absolute;
		width: 100%;
		height: 100%;
		left: -100%;
		bottom: -100%;
	}

	#sub-event .cover .left-corner {
		position: absolute;
		bottom: 1.5em;
		left: 1.5em;
		max-width: 70%;
	}

	#sub-event .cover .left-corner .date,
	#sub-event .cover .left-corner .location {
		font-size: 0.8em;
		margin-top: 0.4em;
	}

	#sub-event .cover .left-corner .title {
		font-size: 3em;
		font-weight: bold;
		margin-top: 0.5rem;
	}

	#sub-event .cover .left-corner .tip {
		font-size: 1em;
		margin-top: 1rem;
		opacity: 0.4;
	}

	@media only screen and (min-width: 1024px) {
		#sub-event .cover .left-corner {
			bottom: 2em;
			left: 2em;

			font-size: 140%;
		}
	}

	#sub-event .cont {
		position: relative;

		width: 100%;
		height: 100%;

		overflow-y: auto;
		overflow-x: hidden;

		opacity: 0;
		background: rgba(251, 251, 251, 1);

		transition: opacity 0.3s;

		text-align: center;
	}

	#sub-event .cont.show {
		opacity: 1;
	}

	#sub-event .cont .title {
		position: relative;

		text-align: center;
		font-size: 3em;
		font-weight: bold;

		margin-bottom: 1rem;
		padding: 0 2rem;
	}

	#sub-event .cont .date,
	#sub-event .cont .location {
		text-align: center;
		font-size: 0.8em;
		margin-top: 0.5rem;
	}

	#sub-event .cont .info-box {
		padding: 3rem 4rem 4rem;
		color: #333333;
	}

	#sub-event .cont .descr {
		font-size: 1.5em;
		text-align: left;
		margin-top: 1.5rem;
		line-height: 150%;
	}

	#sub-event .cont .scover {
		width: 100%;
		height: 20rem;

		background-repeat: no-repeat;
		background-size: cover;
		background-position: 50% 50%;
	}

	#sub-event .cont .bmap {
		width: 100%;
		height: 30rem;
		pointer-events: none;
	}

	#sub-event .cont .cont-box {
		display: inline-block;

		min-width: 50%;
		max-width: 60%;

		text-align: center;
		margin-top: 2rem;

		padding-bottom: 2rem;
	}

	#sub-event .cont .box {
		position: relative;

		width: 100%;

		background: white;
		border-radius: 3px;
		/*box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);*/
		border: 1px solid rgba(0, 0, 0, 0.08);
		overflow: hidden;

		transition: opacity 0.3s;
	}

	#sub-event .cont .sub-title {
		color: #4C4C4C;
		opacity: 0.5;
		font-size: 1.1em;
		text-align: left;
	}

	#sub-event .cont .apply-prompt {
		color: #262626;
		opacity: 0.5;
		font-size: 1.5em;
		font-weight: bold;
	}

	#sub-event .cont .box-set .box {
		border-radius: 0;
	}

	#sub-event .cont .box-set .box:first-child {
		border-radius: 3px 3px 0 0;
	}

	#sub-event .cont .box-set .box:last-child {
		border-radius: 0 0 3px 3px;
	}

	#sub-event .cont .box.btn:hover {
		opacity: 0.8;
		cursor: pointer;
	}

	#sub-event .cont .box.btn:active {
		opacity: 1;
	}

	#sub-event .cont .box.pad {
		padding: 2rem;
	}

	#sub-event .cont .box.btn {
		padding-left: 0;
		padding-right: 0;
		transition: background 0.3s;
	}

	#sub-event .cont .box.btn.disabled {
		color: #D9D9D9 !important;
		background: #B3B3B3 !important;
		pointer-events: none;
	}

	@media only screen and (max-width: 720px) {
		#sub-event .cont .cont-box {
			max-width: 95%;
			margin-top: 1rem;
			padding-bottom: 1rem;
		}

		#sub-event .cont .scover {
			height: 15rem;
		}

		#sub-event .cont .title {
			font-size: 2em;
		}

		#sub-event .cont .info-box {
			padding: 1.5rem 1rem 2rem;
		}

		#sub-event .cont .descr {
			font-size: 1.2em;
		}
	}
</style>

<script>
	function init(main, args, show, cont) {
		require([
			"com/env", "com/util", "com/event",
			"com/xfilt", "com/login", "com/event",
			"com/map", "com/lang", "com/avatar",
			"com/colstat", "com/formi"
		], function (env, util, event, xfilt, login, event, map, lang, avatar, colstat, formi) {
			if (!args || !args.length) {
				util.emsg("$front.sub.event.no_euid");
				return;
			}

			var euid = parseInt(args[0]);

			if (isNaN(euid)) {
				util.emsg("$front.sub.event.illegal_euid");
				return;
			}

			var tbar = env.get("tbar");

			tbar.setTitle("loading");

			util.scroll(main.find(".cont"), function (n) {
				if (n > 0) {
					tbar.showBanner();
				} else {
					tbar.hideBanner();
				}
			});

			// modules
			var display = {};

			display.render = function (info) {
				var parsed = event.parseInfo(info, { max_title_len: 25 });
				
				var cover = main.children(".cover");
				var cont = main.children(".cont");

				tbar.setTitle(parsed.title, parsed.date);

				cover.ready(function () {
					tbar.setSimple();
					$("body").removeClass("padding-tbar");
					show(true);
				});

				cover.find(".title").html(parsed.title);
				cover.find(".date span").html(parsed.date);

				parsed.location(function (addr) {
					cover.find(".location span").html(addr);
					cont.find(".location span").html(addr);
				});

				cover.css("background-image", "url('" + parsed.cover + "')");

				colstat.stat(parsed.cover, { x: 0, y: 0.5, w: 0.5, h: 0.5 }, function (res) {
					var av = res.average;

					if (!av) return;

					var distw = Math.sqrt(
						Math.pow(256 - av[0], 2) +
						Math.pow(256 - av[1], 2) +
						Math.pow(256 - av[2], 2)
					);

					var distb = Math.sqrt(
						Math.pow(av[0], 2) +
						Math.pow(av[1], 2) +
						Math.pow(av[2], 2)
					);

					// alert([ distb, distw ]);

					if (distb > distw) {
						// black text
						cover.css("color", "#191919");
					} else {
						cover.css("color", "#E6E6E6");
					}
				});

				main.children(".loader").removeClass("active");

				cont.find(".scover").css("background-image", "url('" + parsed.cover + "')");
				cont.find(".title").html(parsed.title);
				cont.find(".descr").html(parsed.descr);
				cont.find(".date span").html(parsed.date);

				cont.find(".detail").html(parsed.detail);

				map.embed(main.find(".bmap"), function (bmap) {
					if (parsed.loclng && parsed.loclat)
						bmap.set(parsed.loclng, parsed.loclat, 15);
				}, { initPos: false, canMark: false });

				cont.find(".bmap-box").dimmer({ on: "hover" });

				cont.find(".bmap-box .view-btn").click(function () {
					map.init({ init_lng: parsed.loclng, init_lat: parsed.loclat, view: true, prompt: "loading address" });
				});

				var ava = cont.find(".org");
				var fill = ava.children();

				var size;

				switch (info.org.length) {
					case 1: size = "5em"; break;
					case 2: size = "4em"; break;
					default: size = "3em";
				}

				for (var i = 0; i < parsed.org.length; i++) {
					foci.get("/user/info", { uuid: parsed.org[i] }, function (suc, dat) {
						if (!suc) {
							util.emsg(dat);
							dat = null;
						}

						avatar.init(ava, dat, {
							size: size
						});

						fill.remove();
					});
				}

				function getRForm(session, type, cb) {
					foci.encop(session, {
						int: "event",
						action: "rform",
						euid: euid,
						type: type
					}, cb);
				}

				function apply(session, type, cb) {
					getRForm(session, type, function (suc, dat) {
						if (suc) {
							var next = function (form, hide_form) {
								foci.encop(session, {
									int: "event",
									action: "apply",
									euid: euid,
									type: type,
									form: form
								}, function (suc, dat) {
									if (suc) {
										util.suc(true, "Your application has been sent");
									} else {
										util.emsg(dat);
									}

									cb(suc);
									hide_form(suc);
								});
							};

							if (dat) {
								formi.modal(util.json(dat), {
									uid: "apply." + euid + "." + type,
									submit: next,
									cancel: function () {
										cb(false);
									}
								});
							} else {
								next(null, function () {});
							}
						} else {
							util.emsg(dat);
							if (cb) cb(false);
						}
					});
				}

				function setAppPrompt(msg) {
					main.find(".apply-prompt").html(msg);
				}

				function disableApp(msg) {
					setAppPrompt(msg || "Thank you");
					main.find(".apply-staff").addClass("disabled");
					main.find(".apply-partic").addClass("disabled");
				}

				login.session(function (session) {
					if (!session) {
						disableApp("Login first");
						return;
					}

					var uuid = session.getUUID();

					if (info.org.indexOf(uuid) != -1) {
						setAppPrompt("As an owner");
						main.find(".apply-staff").remove();
						main.find(".apply-partic").remove();
				
						main.find(".apply-appcent").css("display", "").click(function () {
							util.jump("#appcent/" + euid);
						});
					} else {
						main.find(".apply-staff").click(function () {
							main.find(".apply-staff .loader").addClass("active");

							apply(session, "staff", function (suc) {
								main.find(".apply-staff" + " .loader").removeClass("active");
								if (suc) disableApp();
							});
						});

						main.find(".apply-partic").click(function () {
							main.find(".apply-partic .loader").addClass("active");
							
							apply(session, "partic", function (suc) {
								main.find(".apply-partic" + " .loader").removeClass("active");
								if (suc) disableApp();
							});
						});
					}
				});
			};

			foci.get("/event/info", { euid: euid }, function (suc, dat) {
				if (suc) {
					display.render(dat);
				} else {
					util.emsg(dat);
				}
			});

			// util.blur(main.find(".dim"), 10);

			main.find(".cover").click(function () {
				main.find(".cover").addClass("hide");
				setTimeout(function () {
					tbar.delSimple();
					$("body").addClass("padding-tbar");

					setTimeout(function () {
						main.find(".cont").addClass("show");
					}, 0);
				}, 400);
			});
		});
	}
</script>
