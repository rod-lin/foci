<div class="sub-appcent">
	<div class="left-panel">
		<div class="logo"></div>
		<div class="mobile-nav">
			<div class="ui secondary menu">
				<a class="item active">Staff</a>
				<a class="item">Participant</a>
			</div>
		</div>
		<div class="tab-set">
			<div class="ui vertical steps" style="width: 100%; border-radius: 0; border-width: 1px 0 1px 0;">
				<div class="step link">
					<i class="hand paper icon"></i>
					<div class="content">
						<div class="title lang" data-replace="$front.sub.appcent.staff">Staff</div>
					</div>
				</div>
				<div class="step link">
					<i class="users icon"></i>
					<div class="content">
						<div class="title lang" data-replace="$front.sub.appcent.partic">Participant</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="tabs">
		<div style="position: relative; height: 100%; width: 100%; overflow: auto;">
			<div class="tab">
				<table class="ui celled padded unstackable table" style="border-radius: 0; border-width: 0 0 1px 0; margin-bottom: 0;">
					<thead></thead>
					<tbody></tbody>
				</table>
				<div class="no-more lang" data-replace="$front.sub.appcent.no_app">no application</div>
			</div>

			<div class="tab">
				<table class="ui celled padded unstackable table" style="border-radius: 0; border-width: 0 0 1px 0; margin-bottom: 0;">
					<thead></thead>
					<tbody></tbody>
				</table>
				<div class="no-more lang" data-replace="$front.sub.appcent.no_app">no application</div>
			</div>
		</div>
	</div>
</div>

<style>
	.sub-appcent {
		width: 100%;
		height: 100%;
	}

	.sub-appcent .left-panel {
		position: fixed;

		z-index: 1;

		left: 0;

		height: 100%;
		width: 15rem;

		background: rgba(253, 253, 253, 1);
		border-right: 1px solid rgba(0, 0, 0, 0.08);

		text-align: center;
	}
	
	.sub-appcent .left-panel .mobile-nav {
		display: none;
		
		font-size: 1rem;
		
		vertical-align: middle;
	}
	
	.sub-appcent .left-panel .mobile-nav .item {
		color: rgb(90, 90, 90) !important;
	}

	.sub-appcent .left-panel .logo {
		display: inline-block;

		width: 7rem;
		height: 7rem;
		border-radius: 50%;

		margin-top: 3em;

		background-color: #E6E6E6;
		
		cursor: pointer;

		background-repeat: no-repeat;
		background-size: cover;
		background-position: 50% 50%;

		box-shadow: 0 0 15px rgba(0, 0, 0, 0.04);
	}

	.sub-appcent .left-panel .tab-set {
		margin-top: 3em;
		width: 100%;
	}

	.ui.steps .step.active {
		border-radius: 0 !important;
	}

	.ui.steps .step.active .title {
		color: rgba(0, 0, 0, .87) !important;
	}

	.sub-appcent .tabs {
		position: relative;

		top: 0;
		left: 0;
		
		padding-left: 15rem;

		height: 100%;
		width: 100%;
	}

	.sub-appcent .tabs .tab {
		position: absolute;
		
		width: 100%;
		height: 100%;

		overflow: auto;
	
		opacity: 0;
		visibility: hidden;

		transition: opacity 0.3s;
	}

	.sub-appcent .tabs .tab.show {
		opacity: 1;
		visibility: visible;
	}

	.sub-appcent .tabs .tab .no-more {
		display: none;
	}

	.sub-appcent .tabs .empty .no-more {
		display: block;
		width: 100%;

		text-align: center;
		color: #CCCCCC;
		font-weight: bold;

		padding: 1rem;
	}

	.sub-appcent .tabs table {
		transition: margin-top 0.2s;
	}

	.sub-appcent .tabs .empty table {
		border: 0 !important;
	}

	.sub-appcent .tabs .user-name {
		margin-left: 0.2rem;
		margin-bottom: 0.2rem;
		font-weight: bold;
	}

	.sub-appcent .tabs .status {

	}

	.sub-appcent .tabs .option-bar {
		padding: 1.5em;
		background: #F9FAFB;

		opacity: 0;

		border-bottom: 1px solid rgba(0, 0, 0, 0.08);

		transition: margin-top 0.2s, opacity 0.2s 0.2s;
	}

	.sub-appcent .tabs .option-bar.show {
		margin-top: 0 !important;
		opacity: 1;

		transition: margin-top 0.2s, opacity 0s;
	}

	.sub-appcent .tabs .item {
		cursor: pointer;
	}

	.sub-appcent .tabs .item.selected,
	.sub-appcent .tabs .item:hover {
		background: rgba(0, 0, 0, 0.007);
	}

	.sub-appcent .tabs .option-btn {
		border: none !important;
		box-shadow: none !important;
		padding: 0 !important;

		margin-right: 1rem;
	}

	.sub-appcent .tabs .option-prompt {
		color: #CCCCCC;
	}

	.sub-appcent .tabs table td.pending {
		background: #FDFEFF !important;
		color: #216897;
	}

	@media only screen and (max-width: 640px) {
		.sub-appcent .left-panel {
			width: 100%;
			height: 4rem;
			line-height: 4rem;
			
			font-size: 50%;
			text-align: left;
			
			border-right: none;
			border-bottom: 1px solid rgba(0, 0, 0, 0.08);
		}
		
		.sub-appcent .left-panel .tab-set {
			display: none;
		}
		
		.sub-appcent .left-panel .mobile-nav {
			display: inline-block;
		}

		.sub-appcent .left-panel .logo {
			width: 2.5rem;
			height: 2.5rem;
			
			opacity: 0.8;
			border-radius: 5px;
			
			margin: 0.75rem;
			
			vertical-align: middle;
		}

		.sub-appcent .tab-set .step {
			font-size: 120%;
		}

		.sub-appcent .tab-set .step .icon {
			margin-bottom: 0.4em;
		}

		.sub-appcent .tabs {
			padding-left: 0;
			padding-top: 4rem;
		}
		
		.sub-appcent .float-header {
			margin-top: 4rem;
		}

		.sub-appcent .tabs .option-bar {
			padding-top: 1rem;
		}

		.sub-appcent .tabs .option-btn {
			margin-top: 0.5rem;
		}

		.sub-appcent .tabs .option-prompt {
			display: block;
			margin-top: 1rem;
		}
	}
</style>

<script>

	function init(main, args, show, cont) {
		require([
			"com/env", "com/util", "com/event",
			"com/xfilt", "com/login", "com/event",
			"com/map", "com/lang", "com/avatar",
			"com/formi", "com/rating", "com/notice",
			"com/realname"
		], function (env, util, event, xfilt, login, event, map, lang, avatar, formi, rating, notice, realname) {
			if (!args || !args.length) {
				util.emsg("$front.sub.event.no_euid");
				return;
			}

			var euid = parseInt(args[0]);

			if (isNaN(euid)) {
				util.emsg("$front.sub.event.illegal_euid");
				return;
			}

			var tbar = env.get("tbar");

			tbar.setTitle("Application center");

			login.session(function (session) {
				if (!session) {
					show(false);
					return;
				}

				var left_panel = main.find(".left-panel");

				var tab = (function () {
					var ret = {};
					var tabset = left_panel.find(".tab-set, .mobile-nav");

					tabset.find(".step, .item").click(function () {
						tabset.find(".step.active, .item.active").removeClass("active");
						var n = $(this).addClass("active").index();
						
						$(tabset.find(".step")[n]).addClass("active");
						$(tabset.find(".item")[n]).addClass("active");
						
						ret.show(n);
					});

					ret.show = function (n) {
						main.find(".tabs .tab.show").removeClass("show");
						$(main.find(".tabs .tab")[n]).addClass("show");
					};

					ret.get = function (n) {
						return $(main.find(".tabs .tab")[n]);
					};

					$(tabset.find(".step, .item")[0]).click();

					return ret;
				})();

				var table = (function () {
					var ret = {};

					ret.setHeader = function (tab, titles) {
						var head = $("<tr></tr>");

						for (var i = 0; i < titles.length; i++) {
							head.append($("<th class='single line'></th>").append(titles[i]));
						}

						tab.find("thead").html(head);

						return head;
					};

					ret.addItem = function (tab, dat) {
						var item = $("<tr class='item'></tr>");

						for (var i = 0; i < dat.length; i++) {
							item.append(dat[i]);
						}

						tab.find("tbody").append(item);

						return item;
					};
					
					ret.fixHeader = function (tab, cb) {
						tab.ready(function () {
							var copy = tab.clone();
							var scroll = $("<div></div>");

							tab.find("thead").css("visibility", "hidden");

							scroll.append(copy);

							scroll.css({
								"overflow": "hidden",
								"height": tab.find("thead").height() + "px",
								"margin": "0"
							});

							// wrap another div for extra blocks
							var cont = $("<div class='float-header'></div>").css({
								"position": "fixed"
							}).append(scroll).addClass("top-tbar");

							var par = tab.parent();

							var ofs = par[0].offsetWidth - par[0].clientWidth;

							$(window).resize(function () {
								cont.css("width", par.width() - ofs + "px");
								copy.css("width", tab.width() + "px");
							}).resize();

							par.scroll(function () {
								scroll.scrollLeft(par.scrollLeft());
							});

							tab.after(cont);

							if (cb) cb(copy.find("thead"));
						});
					};

					ret.updateHeader = function (tab) {
						tab.parent().find(".float-header table tbody").html(tab.find("tbody").html());
					};

					return ret;
				})();

				function render(ev, app) {
					// left panel
					var parse = event.parseInfo(ev);
					util.bgimg(left_panel.find(".logo"), parse.logo);

					var enable_rating = ev.state == foci.evstat.terminated;

					left_panel.find(".logo").click(function () {
						util.jump("#event/" + euid);
					});

					// tabs

					var init_header = [ " \
						<div class='ui fitted checkbox check-all'> \
							<input type='checkbox'><label></label> \
						</div> \
					",
						"<span class='lang' data-replace='$front.sub.appcent.status'>Status</span>",
						"<span class='lang' data-replace='$front.sub.appcent.user'>User</span>",
						"<span class='lang' data-replace='$front.sub.appcent.apply_for'>Apply for</span>"
					];

					function headerList(fields) {
						var ret = init_header.slice();

						for (var k in fields) {
							if (fields.hasOwnProperty(k)) {
								var h = new String(fields[k].name);
								h.iname = k;
								ret.push(h);
							}
						}

						return ret;
					}

					function genItem(list /* list generated by headerList */, app, type, cb) {
						var user = $(" \
							<td class='single line collapsing'> \
								<div class='avatar' style='display: inline-block;'></div> \
								<div class='trivial' style='display: inline-block; vertical-align: middle; margin-left: 0.3rem;'></div> \
							</td> \
						");
						// var rattd = $("<td class='single line collapsing'></td>");

						var ratdom = $(" \
							<td class='single line collapsing rating-val' style='text-align: center;'> \
								" + (app.rating ? app.rating.rating + "/10" : "N/A") + " \
							</td> \
						");

						var check = $(" \
							<td class='collapsing item-check'> \
								<div class='ui fitted checkbox' style='pointer-events: none;'> \
									<input type='checkbox'><label></label> \
								</div> \
							</td> \
						");

						var status = genStatus(app);

						var applyfor = $("<td class='center aligned collapsing'>" + (type == "staff" ? "Staff" : "Participant") + "</td>");

						if (list.length <= init_header.length + 1) {
							// no other fields
							applyfor.removeClass("collapsing");
						}

						var item = [
							check, status, user, applyfor
						];
						
						var use_rating = type == "staff" && enable_rating;
						
						if (use_rating) {
							item.splice(1, 0, ratdom);
						}

						var form = app.form;

						// fill in all supplied fields
						for (var i = init_header.length + (use_rating ? 1 : 0);
							 i < list.length; i++) {
							if (form && form.hasOwnProperty(list[i].iname)) {
								var val = form[list[i].iname].val;
	
								if (val && val.hasOwnProperty("dval")) val = val.dval; // replace with display value
								
								item.push("<td>" + val + "</td>");
							} else {
								item.push("<td>N/A</td>");
							}
						}
						
						util.userInfo(app.uuid, function (dat) {
							var ava = avatar.init(user.find(".avatar"), dat, { size: "3em", popdir: "top left" });

							dat = login.parseInfo(dat);

							var uname = $("<div class='user-name'></div>");
							var loaded = false;
							var load = function () {
								if (loaded) return;
								loaded = true;
								if (cb) cb();
							};

							uname.append(realname.badge(app.uuid, euid, { onLoad: load }));
							
							uname.append("<span>" +
										 xfilt(dat.dname) + "</span>");

							user.find(".trivial").append(uname);
							// var rat = rating.init(user.find(".trivial"), dat.rating);

							var ratdom = rating.init(user.find(".trivial"));

							util.ratingOf(app.uuid, ratdom.set);
							
							setTimeout(load, 3000);
						});
						
						check.find(".checkbox").checkbox();

						return {
							dat: item,
							select: function () {
								check.find(".checkbox").checkbox("toggle");
							}
						};
					}

					function setStatus(dom, status) {
						dom.removeClass("positive negative pending");

						switch (status) {
							case "accept":
								dom.addClass("positive");
								dom.find(".icon").removeClass("circle cancel check").addClass("check");
								dom.find(".status-prompt").html("Accepted");
								break;

							case "auto":
								dom.addClass("positive");
								dom.find(".icon").removeClass("circle cancel check").addClass("check");
								dom.find(".status-prompt").html("Auto");
								break;

							case "decline":
								dom.addClass("negative");
								dom.find(".icon").removeClass("circle cancel check").addClass("cancel");
								dom.find(".status-prompt").html("Declined");
								break;

							default:
								dom.addClass("pending");
								dom.find(".icon").removeClass("circle cancel check").addClass("circle");
								dom.find(".status-prompt").html("Pending");
						}
					}

					function genStatus(app) {
						var ret = $(" \
							<td class='status center aligned collapsing'> \
								<i class='icon'></i><span class='status-prompt'></span> \
							</td> \
						");

						setStatus(ret, app.status);

						return ret;
					}

					function showOption(par, n) {
						par.find(".option-bar")
							.addClass("show")
							.find(".option-selnum").html(n);

						// alert(par.find(".option-bar").outerHeight());
						par.children("table").css("margin-top", par.find(".option-bar").outerHeight());
					}

					function hideOption(par) {
						par.find(".option-bar").removeClass("show");
						par.children("table").css("margin-top", "");
					}

					function checkAll(rtab) {
						$(rtab.find("tbody tr td.item-check .checkbox")).checkbox("check");
						rtab.find("tbody tr").addClass("selected");
						rtab.parent().find(".check-all").checkbox("check");
					}

					function uncheckAll(rtab) {
						$(rtab.find("tbody tr td.item-check .checkbox")).checkbox("uncheck");
						rtab.find("tbody tr").removeClass("selected");
						rtab.parent().find(".check-all").checkbox("uncheck");
					}

					// update top option bar(accept or reject)
					// called every time when selection state changes
					function updateOption(rtab) {
						var selected = rtab.find("tbody tr.selected");

						if (selected.length) {
							// someone is selected
							showOption(rtab.parent(), selected.length);
						} else {
							// empty selection
							hideOption(rtab.parent());
						}
					}

					function getSelectedUUID(rtab) {
						var selected = rtab.find("tbody tr.selected");
						var ret = [];

						for (var i = 0; i < selected.length; i++) {
							ret.push(parseInt($(selected[i]).attr("data-uuid")));
						}

						return ret;
					}

					function changeStatus(btn, rtab, type, status) {
						var selected = rtab.find("tbody tr.selected");

						rtab.find("tbody tr.negative").removeClass("negative");

						if (selected.length) {
							var uuids = [];

							var nonpend = false;

							for (var i = 0; i < selected.length; i++) {
								var cur_status = $(selected[i]).attr("data-status");
								
								if (cur_status !== "pending" && cur_status !== undefined) {
									// already accepted/declined
									nonpend = true;
									$(selected[i]).addClass("negative");
								}
								
								uuids.push(parseInt($(selected[i]).attr("data-uuid")));
							}

							// if (fail) return;
							
							var next = function () {
								btn.addClass("loading");

								foci.encop(session, {
									int: "event",
									action: "appstatus",
									euid: euid,
									uuids: uuids,
									type: type,
									status: status
								}, function (suc, dat) {
									btn.removeClass("loading");

									if (suc) {
										// update statuses
										var statuses = selected.find(".status");

										for (var i = 0; i < statuses.length; i++) {
											setStatus($(statuses[i]), status);
										}

										selected.attr("data-status", status);

										table.updateHeader(rtab);

										uncheckAll(rtab);
										updateOption(rtab);
									} else {
										util.emsg(dat);
									}
								});
							};
							
							if (nonpend) {
								util.ask("Some of chosen users has already been accepted/declined. Are you sure to continue?",
										 function (yes) {
											 if (yes) {
												rtab.find("tbody tr.negative").removeClass("negative");
												next();
											 }
										 });
							} else next();
						}
					}

					function initTab(n, type) {
						var rtab = tab.get(n).find("table");
						var form = formi.genForm(util.json(app[type + "_form"]));

						// field titles are generated here
						// field values are filled in in genItem function
						var hlist = headerList(form.fields);

						if (type == "staff" && enable_rating) {
							// console.log(hlist);
							hlist.splice(1, 0, "Rating");
						}

						var header = table.setHeader(rtab, hlist);

						var loaded = false;

						if (!app[type].length) {
							rtab.parent().addClass("empty");
						} else {
							var loaded = 0;
							
							for (var i = 0; i < app[type].length; i++) {
								(function (i) {
									var item = genItem(hlist, app[type][i], type, function () {
										loaded++;
										if (loaded == app[type].length) {
											table.fixHeader(rtab, function (header) {
											var checkall = $(header.find("th .checkbox")[0]);

											// option bar
											var accept = $(" \
												<button class='option-btn ui basic positive icon button' style='box-shadow: none !important;'> \
													<i class='check icon'></i> \
													<span class='lang' data-replace='$front.sub.appcent.accept'>Accept</span> \
												</button> \
											");

											var decline = $(" \
												<button class='option-btn ui basic negative icon button' style='box-shadow: none !important;'> \
													<i class='cancel icon'></i> \
													<span class='lang' data-replace='$front.sub.appcent.decline'>Decline</span> \
												</button> \
											");

											var ntbtn = $(" \
												<button class='option-btn ui basic blue icon button' style='box-shadow: none !important;'> \
													<i class='bell outline icon'></i> \
													<span class='lang' data-replace='$front.sub.appcent.notice'>Notice</span> \
												</button> \
											");
											
											var ratebtn = $(" \
												<button class='option-btn ui basic yellow icon button' style='box-shadow: none !important;'> \
													<i class='empty star icon'></i> \
													<span class='lang' data-replace='$front.sub.appcent.rate'>Rate</span> \
												</button> \
											");

											var opt = $("<div class='option-bar'> \
												<span class='option-prompt'><span class='option-selnum'></span> application(s) selected</span> \
											</div>");

											accept.click(function () { changeStatus($(this), rtab, type, "accept"); });
											decline.click(function () { changeStatus($(this), rtab, type, "decline"); });

											ntbtn.click(function () {
												var selected = rtab.find("tbody tr.selected");
												var uuids = getSelectedUUID(rtab);
												var names = [];

												for (var i = 0; i < selected.length; i++) {
													names.push($(selected[i]).find(".user-name").html());
												}

												var prompt = "To ";

												switch (names.length) {
													case 0: prompt += "no one"; break;
													case 1:
														prompt += names[0];
														break;

													case 2:
														prompt += names[0] + " and " + names[1];
														break;

													case 3:
														prompt += names[0] + ", " + names[1] + " and " + names[2];
														break;

													default:
														prompt += names[0] + ", " + names[1] + ", " + names[2] + " and " + (names.length - 3) + " other applicant(s)";
														break;
												}

												notice.editor({
													logo: parse.logo, prompt: prompt,
													onSend: function (info, cb) {
														login.session(function (session) {
															foci.encop(session, {
																int: "notice",
																action: "send",
																type: "event",

																sender: euid.toString(),
																uuids: uuids,

																title: info.title,
																msg: info.msg
															}, function (suc, dat) {
																if (suc) {
																	util.emsg("notice has been sent", "success");
																} else {
																	util.emsg(dat);
																}

																cb(suc);
															});
														});
													}
												});
											});

											if (type == "staff" && enable_rating) {
												rating.popup(ratebtn, function (rat, cb) {
													var uuids = getSelectedUUID(rtab);
													var selected = rtab.find("tbody tr.selected");
													var rewrite = false;
													
													selected.each(function (i, dom) {
														if ($(dom).attr("data-hasrating") == "true") {
															rewrite = true;
														}
													});
													
													var next = function () {
														login.session(function (session) {
															foci.encop(session, {
																int: "user",
																action: "ratestaff",
																euid: euid,
																uuids: uuids,
																rating: rat
															}, function (suc, dat) {
																if (!suc) {
																	util.emsg(dat);
																}
																
																cb(suc);
																
																if (suc) {
																	selected.each(function (i, dom) {
																		$(dom).find(".rating-val").html(rat + "/10");
																		$(dom).attr("data-hasrating", true);
																	});
																}
															});
														});
													};
													
													if (rewrite) {
														util.ask("You are overwriting some of the staff's rating(s). Are you sure to continue?",
																 function (yes) {
																 	if (yes) next();
																	else cb(true);
																 });
													} else next();
												});
												
												opt.prepend(ratebtn);
											}
											
											opt.prepend(ntbtn);
											opt.prepend(decline);
											opt.prepend(accept);

											lang.update(opt);

											rtab.parent().find(".float-header").prepend(opt);
											opt.ready(function () {
												$(window).resize(function () {
													opt.css("margin-top", "-" + opt.next().position().top + "px");
												}).resize();
											});

											checkall.checkbox();

											// select all checkbox behavior
											checkall.click(function () {
												if (rtab.find("tbody tr").not(".selected").length == 0) {
													// all checked -> uncheck all
													uncheckAll(rtab);
												} else {
													// not all checked -> check all
													checkAll(rtab);
												}

												updateOption(rtab);
											});
										});
										}
									});

									var dom = table.addItem(rtab, item.dat);

									dom.attr("data-uuid", app[type][i].uuid);
									dom.attr("data-status", app[type][i].status);
									dom.attr("data-hasrating", !!app[type][i].rating);

									// single checkbox
									dom.click(function () {
										item.select();
										dom.toggleClass("selected");
										updateOption(rtab);
									});
								})(i);
							}
						}
					}

					initTab(0, "staff");
					initTab(1, "partic");

					show(true);
				}

				// $(window).resize(function () {
				// 	// main.children(".tabs").width(main.width() - main.children(".left-panel").width());
				// }).resize();

				util.eventInfo(euid, function (dat) {
					foci.encop(session, {
						int: "event",
						action: "getapp",
						euid: euid
					}, function (suc, app) {
						if (suc) {
							render(dat, app);
						} else {
							util.emsg(app);
						}
					});
				});
			});
		});
	}

</script>
