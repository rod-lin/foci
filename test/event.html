<!-- event -->
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Pragma" content="no-cache">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

		<link rel="stylesheet" href="font/fontawesome/import.css">
		<link rel="stylesheet" href="font/ubuntu/import.css">

		<link rel="stylesheet" href="css/com.css">
		<link rel="stylesheet" href="css/event.css">
	</head>
	
	<body>
		<div id="event-main" class="event-not-owner">
			<span id="event-cont">
				<div id="event-topbar">
					<div id="event-info-rating">8.5</div>
					<span class="event-logo" style="background-image: url('img/tmp1.jpg');""></span>
					<div class="event-info">
						<div id="event-info-title" style="font-size: 2em; margin-bottom: 0.5em; font-weight: bold;"></div>
						<span class="fa fa-map-pin" style="margin-right: 9px; font-size: 80%;"></span>
						<span id="event-info-location"></span></br>
						<span class="fa fa-clock-o" style="margin-right: 5px; font-size: 80%;"></span>
						<span id="event-info-time"></span>
					</div>
				</div>
				<div class="event-info-block">
					<div id="event-info-descr"></div>
					<textarea id="event-info-descr-edit" class="event-edit-box" style="display: none;"></textarea>
					<div id="event-set-btn-descr" class="fa fa-cog event-set-btn"></div>
				</div>
				<div id="event-info-descr-pic" class="event-info-block event-info-block-restrict">
					<div style="position: block; height: 100%; width: 100%; overflow-x: scroll">
						<div class="event-info-pic" style="background-image: url('img/tmp1.jpg');"></div>
						<div class="event-info-pic" style="background-image: url('img/tmp2.jpg');"></div>
						<div class="event-info-pic" style="background-image: url('img/tmp1.jpg');"></div>
						<div class="event-info-pic" style="background-image: url('img/tmp2.jpg');"></div>
						<div class="event-info-pic" style="background-image: url('img/tmp1.jpg');"></div>
					</div>
					<div class="event-info-block-shade"></div>
				</div>

				<div id="event-info-people" class="event-info-block event-info-block-restrict">
					<div id="event-info-people-org"></div>
					<div id="event-info-people-staff" style="margin-top: 1.5em;"></div>
					<div id="event-info-people-partic" style="margin-top: 1.5em;"></div>
					<!-- <div class="event-info-people-title">organizers</div>
					<div>
						<div class="event-info-people-box">
							<div class="event-info-people-icon" style="background-image: url('img/deficon.jpg');"></div><br>
							<span class="event-info-people-dname">Name</span>
						</div>
					</div>

					<div>
						<div class="event-info-people-title">staffs</div>
						<div class="event-info-people-box">
							<div class="event-info-people-icon" style="background-image: url('img/deficon.jpg');"></div><br>
							<span class="event-info-people-dname">Name</span>
						</div>
					</div>

					<div class="event-info-people-title">participants</div>
					<div>
						<div class="event-info-people-box">
							<div class="event-info-people-icon" style="background-image: url('img/tmp3.jpg');"></div><br>
							<span class="event-info-people-dname">Name</span>
						</div>

						<div class="event-info-people-box">
							<div class="event-info-people-icon" style="background-image: url('img/tmp2.jpg');"></div><br>
							<span class="event-info-people-dname">Name</span>
						</div>
						<div class="event-info-people-box">
							<div class="event-info-people-icon" style="background-image: url('img/tmp1.jpg');"></div><br>
							<span class="event-info-people-dname">Name</span>
						</div>
					</div> -->
					<div class="event-info-block-shade"></div>
				</div>

				<div class="event-info-block" style="text-align: center; font-size: 1.4em;">
					<!-- <div style="font-size: 160%; font-weight: bold; margin-bottom: 0.5em;">I wanna be</div> -->
					<div id="event-info-join-staff" class="com-button com-button-green" style="width: 3em;">staff</div>
					<div id="event-info-join-partic" class="com-button com-button-blue" style="width: 5em;">participant</div>
				</div>
			</span>
		</div>

		<script src="fcauth.js"></script>
		<script src="vcent.js"></script>
		<script>
			"use strict";

			Array.prototype.choose = function () {
				return this[Math.floor(Math.random() * this.length)];
			};

			function jump(url) {
				window.location = url;
			};

			window.onload = function () {
				var color_boxa = [ "#1ABC9C", "#2ECC71", "#3498DB", "#9B59B6", "#E67E22", "#E74C3C" ];
				var color_boxb = [ "#16A085", "#27AE60", "#2980B9", "#8E44AD", "#D35400", "#C0392B" ];

				var setbtn_reg = {
					"event-set-btn-descr": [
						function () {
							$("#event-info-descr").css("display", "none");
							$("#event-info-descr-edit").css("display", "");
							$("#event-info-descr-edit").val($("#event-info-descr").html().replace("<br>", "\n"));
						},

						function () {
							$("#event-info-descr").css("display", "");
							$("#event-info-descr-edit").css("display", "none");

							FCAuth.encop(gsession, {
								int: "event",
								action: "setinfo",
								euid: euid,
								descr: $("#event-info-descr-edit").val()
							}, function (suc, dat) {
								if (suc) {
									updateInfo();
								} else {
									alert(dat);
								}
							});
						}
					]
				};

				$(".event-set-btn").click(function () {
					$(this).parent().toggleClass("event-info-block-edit");

					$(this).toggleClass("fa-cog");
					$(this).toggleClass("fa-check");
					$(this).toggleClass("event-set-btn-check");

					var reg = setbtn_reg[$(this).attr("id")];
					var i = $(this).hasClass("fa-cog") + 0;

					if (reg) {
						reg[i]();
					}
				});

				$("#event-info-join-partic").click(function () {
					if (!gsession) {
						alert("log in first");
						return;
					}

					var btn = $(this);
					var cont = btn.html();
					btn.html("<span class='fa fa-cog fa-spin'></span>");

					FCAuth.encop(gsession, {
						int: "event",
						action: "reg",
						euid: euid,
						type: "partic"
					}, function (suc, dat) {
						if (suc) {
							setTimeout(function () {
								btn.html("<span class='fa fa-check'></span>");
							}, 300);

							setTimeout(function () {
								btn.html(cont);
								updateInfo();
							}, 1000);
						} else {
							alert(dat);
							setTimeout(function () {
								btn.html(cont);
							}, 700);
						}
					});
				});

				function formatTime(start, end) {
					var ret = "";
					var form = function (date) {
						return date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + date.getDate();
					};

					if (start) {
						ret += form(new Date(start));
					} else {
						ret += "TBD"
					}

					ret += " ~ ";

					if (end) {
						ret += form(new Date(end));
					} else {
						ret += "TBD"
					}

					return ret;
				};

				// <div class="event-info-people-box">
				// 			<div class="event-info-people-icon" style="background-image: url('img/tmp1.jpg');"></div><br>
				// 			<span class="event-info-people-dname">Name</span>
				// 		</div>
				function genHeaderBox(user) {
					return ' \
					<div class="event-info-people-box"> \
						<div class="event-info-people-icon" style="background-image: url(\'' +
							(user.avatar ? FCAuth.download(user.avatar) : "img/deficon.jpg") +
						'\');"></div><br> \
						<span class="event-info-people-dname">' + user.dname + '</span> \
					</div>';
				}

				function genPeopleBox(users, title /* staffs, participants, etc. */) {
					var ret = "";

					ret += '<span class="event-info-people-title">' + title + '</span><div class="event-split"></div>';

					if (!users.length) {
						ret += '<span class="event-info-people-title">none</span>';
						return ret;
					}

					for (var i = 0; i < users.length; i++) {
						ret += genHeaderBox(users[i]);
					}

					return ret;
				}

				function initPeopleBox(uuids, name, anchor) {
					anchor.html("");

					if (!uuids.length) {
						anchor.append(genPeopleBox([], name));
						return;
					}

					for (var i = 0, tmp = []; i < uuids.length; i++) {
						FCAuth.get("/user/info", { uuid: uuids[i] },
							(i == uuids.length - 1 ?
							
							(function (suc, dat) {
								if (suc) {
									tmp.push(dat);
								} else {
									console.log("failed to get user: " + dat);
								}

								anchor.append(genPeopleBox(tmp, name));
							}) :

							(function (suc, dat) {
								if (suc) {
									tmp.push(dat);
								} else {
									console.log("failed to get user: " + dat);
								}
							}))
						);
					}
				}

				function setInfo(dat) {
					$("#event-info-title").html(dat.title);

					$("#event-info-location").html(dat.location || "TBD");
					$("#event-info-time").html(formatTime(dat.start, dat.end));

					$("#event-info-descr").html(dat.descr.replace("\n", "<br>") || "no description");

					vcent.update();

					initPeopleBox(dat.org, "organizers", $("#event-info-people-org"));
					initPeopleBox(dat.staff, "staffs", $("#event-info-people-staff"));
					initPeopleBox(dat.partic, "participants", $("#event-info-people-partic"));
				}

				function updateInfo() {
					FCAuth.get("/event/info", { euid: euid }, function (suc, dat) {
						if (suc) {
							setInfo(dat);
						} else {
							alert(dat);
						}
					});
				}

				var euid = parseInt(window.location.hash.substring(1));
				var gsession = null;

				if (isNaN(euid)) alert("no euid given");
				else {
					updateInfo();

					FCAuth.qlogin(function (suc, dat) {
						if (suc) {
							gsession = dat;
							FCAuth.encop(gsession, {
								int: "event",
								action: "own",
								euid: euid
							}, function (suc, dat) {
								if (suc && dat) {
									$("#event-main").removeClass("event-not-owner");
								}
							});
						}
					});
				}
			};
		</script>
	</body>
</html>
