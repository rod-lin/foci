<style>
	.column {
		background: black;
	}

	#sub-profile {
		height: 100%;
	}

	#sub-profile .left-bar {
		position: fixed;
		width: 20em;
		height: 100%;

		padding: 0 2rem;

		background: rgba(253, 253, 253, 0.7);
		border: 1px solid rgba(0, 0, 0, 0.1);
		border-width: 0 1px 0 0;

		text-align: center;

		overflow: auto;
	}

	#sub-profile .left-bar .avatar {
		display: inline-block;

		width: 9em;
		height: 9em;
		margin-top: 4em;

		border-radius: 50%;

		background-image: url("img/matt.jpg");

		background-repeat: no-repeat;
		background-size: cover;
		background-position: 50% 50%;

		box-shadow: 0 0 3px rgba(0, 0, 0, 0.3);
	}

	#sub-profile .left-bar .avatar.empty {
		background: rgba(0, 0, 0, 0.2);
	}

	#sub-profile .left-bar .dname {
		margin: 1rem 0 0 0;

		font-size: 2em;
		font-weight: bold;

		color: #262626;
	}

	#sub-profile .left-bar .rating {
		margin: 0.5rem 0 0 0;
	}

	#sub-profile .left-bar .descr {
		margin: 1rem 0 2rem 0;
		padding: 0 1rem;
		color: #999999;
	}

	#sub-profile .right-bar {
		position: relative;
		margin-left: 20em;
		height: 100%;
	}

	#sub-profile .right-bar.main-tab {
		height: 100%;
	}

	@media only screen and (max-width: 640px) {
		#sub-profile .left-bar {
			position: relative;
			height: auto;
			width: 100%;
			padding-bottom: 2rem;
			border-width: 0 0 1px 0;
		}

		#sub-profile .right-bar {
			margin-left: 0;
		}
	}
</style>

<div id="sub-profile">
	<div class="left-bar">
		<div class="avatar empty"></div>
		<div class="dname"></div>
		<div class="ui rating" data-max-rating="5"></div>
		<div class="descr"></div>
		<div class="ui horizontal divider">Some Data</div>
		<div class="ui grey statistic">
			<div class="value follows">
				--
			</div>
			<div class="label">
				Follows
			</div>
		</div>
		<div class="ui grey statistic">
			<div class="value followers">
				--
			</div>
			<div class="label">
				Followers
			</div>
		</div><br>
		<div class="ui grey statistic">
			<div class="value participated">
				--
			</div>
			<div class="label">
				Participated
			</div>
		</div>
	</div>
	<div class="right-bar">
		<div class="main-tab"></div>
		<!-- <div class="menu">
			<div class="item active partic-btn">Participating</div><div class="item org-btn">Organized</div>
		</div>
		<div class="tab">
			<div class="partic-event active"></div>
			<div class="org-event active"></div>
		</div> -->
	</div>

	<style>
		
		#sub-profile .new-event {
		}

		#sub-profile .new-event .ev-content {
			position: absolute;
			width: 70%;

			top: 0;
			left: 30%;

			border: 1px solid rgba(0, 0, 0, 0.1);
			border-width: 0 0 0 1px;
		}

		#sub-profile .new-event .ev-step {
			position: absolute;
			width: 30%;

			top: 0;
			left: 0;
		}

		#sub-profile .new-event .no-style {
			margin: 0;
			padding: 0;
			background: 0;
			outline: none;
			border: 0;
			resize: none;
		}

		#sub-profile .new-event .ev-title {
			width: 100%;
			padding: 2rem;
			background: white;
			color: #252525;

			font-size: 2em;
			font-weight: bold;

			border: 1px solid rgba(0, 0, 0, 0.1);
			border-width: 0 0 1px 0;
		}

		#sub-profile .new-event .ev-descr {
			width: 100%;
			padding: 2rem;
			background: white;
			color: #252525;

			min-height: 10em;

			font-size: 1.5em;
		}

		#sub-profile .new-event .ui.steps {
			border-width: 0 0 1px 0 !important;
			border-radius: 0 !important;
		}

		#sub-profile .new-event .ui.steps .step {
			border-radius: 0 !important;
		}

		#sub-profile .new-event .ev-content .page {
			display: none;
		}

		#sub-profile .new-event .ev-content .page.active {
			display: block;
		}

		#sub-profile .new-event .ev-content .warning {
			background: #FFF6F6;
			color: #9F3A38;
		}

		#sub-profile .new-event .ev-content .p2,
		#sub-profile .new-event .ev-content .p4 {
			text-align: center;
		}

		.ui.steps .step.active .title {
			color: rgba(0, 0, 0, .87) !important;
		}

		@media only screen and (max-width: 640px) {
			#sub-profile .new-event .ev-content {
				left: 20%;
				width: 80%;
			}

			#sub-profile .new-event .ev-step {
				width: 20%;
			}

			#sub-profile .new-event .ev-step .description {
				display: none;
			}

			#sub-profile .new-event .ev-title {
				padding: 1.4rem;
				font-size: 1.5em;
			}

			#sub-profile .new-event .ev-descr {
				padding: 1.4rem;
				font-size: 1.2em;
			}

			#sub-profile .new-event .ev-step .step {
				font-size: 0.7em;
			}

			#sub-profile .new-event .ev-step .step .icon {
				margin-bottom: 0.1em;
			}
		}

	</style>

	<div class="new-event-draft" style="display: none;">
		<div class="new-event">
			<div class="ev-step">
				<div class="ui vertical fluid steps">
					<div class="link active step info-step">
						<i class="info icon"></i>
						<div class="content">
							<div class="title">Basic Info</div>
							<div class="description">Title and description</div>
						</div>
					</div>
					<div class="link step cover-step">
						<i class="camera retro card icon"></i>
						<div class="content">
							<div class="title">Cover</div>
							<div class="description">Cover and logo</div>
						</div>
					</div>
					<div class="link step loc-step">
						<i class="map outline icon"></i>
						<div class="content">
							<div class="title">Location</div>
							<div class="description">When and where</div>
						</div>
					</div>
					<div class="link step pub-step">
						<i class="send outline icon"></i>
						<div class="content">
							<div class="title">Publish</div>
							<div class="description">Rules and Protocols</div>
						</div>
					</div>
				</div>
			</div>
			<div class="ev-content">
				<!-- <div id="sub-profile-map" class="map"></div> -->
				<div class="page p1 active">
					<input class="ev-title no-style" placeholder="Title">
					<textarea class="ev-descr no-style" placeholder="Description"></textarea>
				</div>
				<div class="page p2"></div>
				<div class="page p3">
					<div class="map"></div>
				</div>
				<div class="page p4">
					<div class="protocol">
						<style>
							
							#sub-profile .new-event .ev-content .p4 .protocol {
								padding: 0 2rem;
							}

							#sub-profile .new-event .ev-content .p4 .protocol .prompt {
								font-size: 2em;
								margin-bottom: 1rem;
								margin-top: -5rem;
							}

						</style>
						<div class="vcenter" style="display: inline-block;">
							<div class="prompt"></div>
							<div class="ui primary button publish-btn">Publish!</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
	function init(main, args, cont) {
		require([
			"com/env", "com/util", "com/event",
			"com/xfilt", "com/pages", "com/tab",
			"com/login", "com/event", "com/upload",
			"com/map"
		], function (env, util, event, xfilt, pages, tab, login, event, upload, map) {
			var init = function (info, is_self) {
				var left_bar = main.find(".left-bar");
				var right_bar = main.find(".right-bar");

				left_bar.find(".dname").html(util.fill());
				left_bar.find(".descr").html(util.fill());

				left_bar.find(".follows").html("--");
				left_bar.find(".followers").html("--");
				left_bar.find(".participated").html("--");

				left_bar.find(".rating").rating("disable").rating("set rating", 0);

				function setDom(info) {
					var avatar = info.avatar ? foci.download(info.avatar) : [ "img/matt.jpg", "img/stevie.jpg", "img/elliot.jpg" ].choose();
					var dname = info.dname ? xfilt(util.short(info.dname, 12)) : "anonymous";
					var descr = info.descr ? xfilt(util.short(info.descr, 128)) : "(no description)";

					var rating = info.rating ? (info.rating[0] + info.rating[1]) / 2 : 0;

					left_bar.find(".rating").rating("set rating", 0);

					left_bar.find(".dname").html(dname);
					left_bar.find(".descr").html(descr);
					left_bar.find(".avatar").css("background-image", "url('" + avatar + "')").removeClass("empty");
				}

				var ev_list = {};

				function eventTabOnShow(name, enc, cb) {
					var next = function (suc) {
						ev_list[name].update();
						setTimeout(function () {
							cb();
						}, 300);
					};


					if (!ev_list[name]) {
						ev_list[name] = event.init(tb.getTab(name), {
							fetch: {
								fetch: function (skip, cb) {
									if (enc) {
										login.session(function (session) {
											foci.encop(session, { int: "event", action: name, skip: skip }, cb);
										});
									} else {
										foci.get("/user/" + name, { uuid: info.uuid, skip: skip }, cb);
									}
								},

								cont: cont,
								no_more_prompt: "no more results"
							}
						});
					}

					ev_list[name].clear(function () {
						ev_list[name].fetch(next);
					});
				}

				var tabs = {
					"partic": {
						name: "Participated",
						onShow: function (show) {
							eventTabOnShow("partic", false, show);
						}
					},

					"org": {
						name: "Organized",
						onShow: function (show) {
							eventTabOnShow("org", false, show);
						}
					}
				};

				var new_tab = main.children(".new-event-draft").children();

				new_tab.find(".ev-title").keyup(function () {
					$(this).removeClass("warning");
				});

				new_tab.find(".ev-descr").keyup(function () {
					$(this).removeClass("warning");
				});

				/*
					To add step, you need to:
						1. Add a step item in the .ev-step
						2. Add a page in the .ev-content
						3. Add the step name in the "steps" array below
						4. Add check and show event in "step_show" and "step_check"
						5. Add initialization code in loadDraft
				 */
				
				"use strict";

				var loadDraft, clearDraft, hasDraft, saveDraft;

				function initDraft() {
					var euid = null;
					var steps = [ "info", "cover", "loc", "pub" ];
					var cur_step = 1;

					var bmap = null;

					var step_show = {};
					var step_check = {
						"info": function (cb) {
							var suc = true;

							if (!new_tab.find(".ev-title").val()) {
								new_tab.find(".ev-title").addClass("warning");
								suc = false;
							}

							if (!new_tab.find(".ev-descr").val()) {
								new_tab.find(".ev-descr").addClass("warning");
								suc = false;
							}

							if (suc) {
								uploadChanges({
									title: new_tab.find(".ev-title").val(),
									descr: new_tab.find(".ev-descr").val()
								}, function (suc) {
									if (suc) {
										new_tab.find(".info-step").addClass("completed");
										cb(true);
									} else {
										cb(false);
									}
								});
							} else cb(false);

							return;
						},

						"cover": function (cb) {
							if (field_cover) {
								uploadChanges({
									cover: field_cover
								}, function (suc) {
									if (suc) {
										new_tab.find(".cover-step").addClass("completed");
										cb(true);
									} else {
										cb(false);
									}
								});
							} else {
								util.ask("You haven't selected any cover. Are you sure to leave?", function (suc) {
									if (suc) {
										// new_tab.find(".cover-step").addClass("completed");
										cb(true);
									} else {
										cb(false);
									}
								});
							}
						},

						"loc": function (cb) {
							if (field_lng && field_lat) {
								uploadChanges({
									loclng: field_lng,
									loclat: field_lat
								}, function (suc) {
									if (suc) {
										// alert(field_lng + ", " + field_lat + " saved");
										new_tab.find(".loc-step").addClass("completed");
										cb(true);
									} else {
										cb(false);
									}
								});
							} else {
								util.ask("You haven't selected any location. Are you sure to leave?", function (suc) {
									if (suc) {
										// new_tab.find(".loc-step").addClass("completed");
										cb(true);
									} else {
										cb(false);
									}
								});
							}
						}
					};

					var field_cover;
					var field_lng, field_lat;

					function setPublishMsg(msg) {
						new_tab.find(".ev-content .protocol .prompt").html(msg);
					}

					function resetPublishMsg() {
						setPublishMsg("Publish your event now for everyone!");
					}
					
					/* loader icon on the New/Save button */
					function setLoader() {
						tb.getItem("new").html("<div class='ui active inverted " + (
							display_mode == "normal"
							? "small" : "tiny"
						) + " inline loader'></div>");
					}

					function delLoader() {
						tb.getItem("new").html("Save");
					}

					function uploadChanges(changes, cb) {
						login.session(function (session) {
							setLoader();

							foci.encop(session, $.extend({
								int: "event",
								action: "setinfo",
								euid: euid
							}, changes), function (suc, dat) {
								delLoader();

								if (!suc) {
									util.qmsg(dat);
								}

								cb(suc);
							});
						});
					}
					
					function checkStep(cb) {
						var check = cur_step <= steps.length ? step_check[steps[cur_step - 1]] : null;
						if (check) {
							check(cb);
						} else cb(true);
					}

					function setStep(page, nocheck) {
						var next = function (cast) {
							if (cast === false) return;

							new_tab.find(".ev-content .page.active").removeClass("active");
							new_tab.find(".ev-step .active").removeClass("active");
							new_tab.find("." + steps[page - 1] + "-step").addClass("active");
							new_tab.find(".ev-content .p" + page).addClass("active");
							cur_step = page;

							var show = step_show[steps[cur_step - 1]];
							if (show) show();
						};

						if (nocheck) next();
						else checkStep(next);
					}

					// step initalize
					function initStep() {
						function set(select, page) {
							// alert("bond " + select + ", " + page);
							new_tab.find(select).on("click", function () {
								setStep(page);
							});
						}

						for (var i = 1; i <= steps.length; i++) {
							set("." + steps[i - 1] + "-step", i);
						}
					}

					function nextStep() {
						if (cur_step < steps.length) {
							setStep(cur_step + 1);
						} else {
							checkStep(function () {});
						}
					}

					clearDraft = function () {
						euid = null;
						cur_step = 1;

						field_cover = null;
						field_lng = null;
						field_lat = null;

						tb.getItem("new").off("click", nextStep);
						tb.getItem("new").html("New");
						// new_tab.find(".ev-step .step").off("click");
					};

					hasDraft = function () {
						return euid != null;
					};

					saveDraft = function (cb) {
						setLoader();
						checkStep(function (suc) {
							delLoader();
							cb(suc);
						});
					};

					loadDraft = function (ev_info) {
						if (!ev_info || !ev_info.euid) {
							util.qmsg("event not created");
							return;
						} // make sure the event has been created

						updateNewEventPos(); // update position

						resetPublishMsg();
						new_tab.find(".ev-content .protocol .publish-btn").removeClass("disabled");
						// alert(ev_info.euid);

						euid = ev_info.euid;
						cur_step = 1;

						var title = ev_info.title ? ev_info.title : "";
						var descr = ev_info.descr ? ev_info.descr : "";

						tb.getItem("new").html("Save")
							.off("click", nextStep); // avoid duplication

						util.nextTick(function () { // avoid bubbling
							tb.getItem("new").on("click", nextStep);
						});

						// page 1
						new_tab.find(".ev-title").val(title);
						new_tab.find(".ev-descr").val(descr);

						// page 2
						var event_tmp = event.eventTemplate();
						new_tab.find(".ev-content .p2").html(event_tmp);
						event_tmp
							.css("display", "inline-block")
							.css("text-align", "left")
							.css("max-width", "90%")
							.css("max-height", "90%")
							.addClass("vcenter");

						field_cover = ev_info.cover;

						event.setDom(event_tmp, {
							title: "Tmplate",
							descr: "Click the picture to change cover",
							cover: ev_info.cover
						}, {
							onCoverClick: function (dom) {
								upload.init(function (file) {
									if (file) {
										field_cover = file;
										dom.changeCover(file);
									}
								});
							}
						});

						// page 3
						field_lng = ev_info.loclng;
						field_lat = ev_info.loclat;

						if (!bmap) {
							map.embed(new_tab.find(".ev-content .p3 .map"), function (map) {
								bmap = map;

								step_show["loc"] = function () {
									bmap.init(); // init position

									if (field_lng && field_lat)
										bmap.set(field_lng, field_lat);
									else
										bmap.clear();
								}

							}, function (lng, lat, addr) {
								field_lng = lng;
								field_lat = lat;
								// alert(lng + ", " + lat + ", " + addr);
							});
						}

						var last = null;

						new_tab.find(".completed").removeClass("completed");

						if (title && descr) {
							new_tab.find(".info-step").addClass("completed");
						} else last = 1;

						if (field_cover) {
							new_tab.find(".cover-step").addClass("completed");
						} else if (!last) last = 2;

						if (field_lng && field_lat) {
							new_tab.find(".loc-step").addClass("completed");
						} else if (!last) last = 3;

						// if (last)
						//	new_tab.find(last).click();
						// initStep(); // initialize event bondings

						setStep(last || 4, true);
					};

					initStep();

					new_tab.find(".ev-content .protocol .publish-btn").click(function () {
						var btn = $(this);

						btn.addClass("loading");

						login.session(function (session) {
							foci.encop(session, {
								int: "event",
								action: "publish",
								euid: euid
							}, function (suc, dat) {
								btn.removeClass("loading");
								
								if (suc) {
									btn.addClass("disabled");
									setPublishMsg("Success! You can now go to the 'Organized' tab to view your event");
								} else {
									util.qmsg(dat);
								}
							});
						});
					});
				};

				if (is_self) {
					initDraft();

					tabs["draft"] = {
						name: "Draft",
						onShow: function (show) {
							eventTabOnShow("draft", true, show);
						}
					};

					tabs["new"] = {
						name: "New",
						float: "right",
						style: "green",

						onShow: function (show) {
							// initBaiduMap();
							
							login.session(function (session) {
								if (hasDraft()) {
									updateNewEventPos();
									show();
								} else {
									// alert("hi");
									foci.encop(session, {
										int: "event",
										action: "new"
									}, function (suc, dat) {
										if (suc) {
											loadDraft({ euid: dat });
											updateNewEventPos();
											show();
										} else {
											util.qmsg(dat);
										}
									});
								}
							});
						},

						onChange: function (cb) {
							saveDraft(function (suc) {
								if (suc !== false) clearDraft();
								cb(suc); // if suc == true, change the tab
							});
							
							return false;
						}
					};
				}

				var tb = tab.init(right_bar.find(".main-tab"), tabs);

				if (is_self)
					tb.getTab("new").html(new_tab);

				tb.to("partic");

				var display_mode = "normal";

				function updateNewEventPos() {
					new_tab
						.find(".ev-descr")
						.css("height", tb.displayHeight() - new_tab.find(".ev-title").outerHeight() + "px");

					new_tab
						.find(".ev-content .p2")
						.css("height", tb.displayHeight());

					new_tab
						.find(".ev-content .p3 .map")
						.css("height", tb.displayHeight());

					new_tab
						.find(".ev-content .p4 .protocol")
						.css("height", tb.displayHeight());
				}

				function updateAllPos(mobile) {
					if (mobile) {
						display_mode = "mobile";
						right_bar.width(main.innerWidth());
						tb.flow(true);
					} else {
						display_mode = "normal";
						right_bar.width(main.innerWidth() - left_bar.outerWidth());
						tb.flow(false);
					}

					updateNewEventPos();
				}

				$(window).resize(function () {
					updateAllPos(!right_bar.offset().left);
				});

				$(window).resize();

				setDom(info);
			};

			if (args && args[0]) {
				var uuid = parseInt(args[0]);

				if (isNaN(uuid)) {
					util.qmsg("illegal uuid");
				} else {
					foci.get("/user/info", { uuid: uuid }, function (suc, dat) {
						if (suc) {
							env.user(function (cur) {
								init(dat, cur && cur.uuid == dat.uuid);
							});
						} else {
							util.qmsg(dat);
						}
					});
				}
			} else {
				if (!env.session()) {
					login.init(function () {
						env.user(function (info) { init(info, true); });
					});
				} else {
					env.user(function (info) { init(info, true); });
				}
			}
		});
	}
</script>
