<!-- main portal -->
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Pragma" content="no-cache">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

		<link rel="shortcut icon" href="img/favicon.ico">
		<link rel="icon" href="img/favicon.ico">

		<script src="lib/foci.js?v=18"></script>
		<script src="lib/vcent.js?v=1"></script>
		<script src="lib/gt.js?v=0"></script> <!-- geetest api -->

		<script src="lib/require.js?v=0"></script>
		<script>
			foci.version = 37;
			foci.config = {
				banner_min_scroll: 500, // min scroll top to trigger banner
				max_upload_size: 1024 * 1024 * 3, // 3m
			};
			
			foci.nested = top != window;
		
			require.config({
				waitSeconds: 0, // ntimeout
				urlArgs: "v=" + foci.version // one version a time, keeps the cache away~~
			});
		</script>

		<link rel="stylesheet" href="font/fontawesome/import.css?v=0">
		<!-- <link rel="stylesheet" href="font/ubuntu/import.css">
		<link rel="stylesheet" href="font/brandon/import.css"> -->
		<link rel="stylesheet" href="font/foci/import.css?v=0">

		<link rel="stylesheet" href="/semantic/semantic.min.css?v=1">
		<script src="/semantic/semantic.min.js?v=1"></script>

		<link rel="stylesheet" href="/css/sui-calendar.css?v=0">
		<script src="/lib/sui-calendar.js?v=0"></script>
		
		<link rel="stylesheet" href="/css/cropper.css?v=0">
		<script src="/lib/cropper.js?v=0"></script>

		<script src="/lib/touch-swipe.js?v=0"></script>
		<script src="/lib/canvas-to-blob.js?v=0"></script>

		<link rel="stylesheet" href="css/com.css?v=3">
		<link rel="stylesheet" href="css/markdown.css?v=0">
		<link rel="stylesheet" href="css/font.css?v=0">

		<!-- <link rel="stylesheet" href="com/tbar/import.css">
		<link rel="stylesheet" href="com/waterfall/import.css">
		<link rel="stylesheet" href="com/xfilt/import.css">
		<link rel="stylesheet" href="com/event/import.css"> -->

		<script src="https://api.map.baidu.com/getscript?v=2.0&ak=B4lBjPwv47t4CNlFiyY4siyy&s=1"></script>

		<style>
			body {
				font-size: 14px;
				
				line-height: normal;
				overflow: hidden;

				background: rgba(255, 255, 255, 1);
				
				transition: padding 0.2s;
			}

			#main {
				position: relative;
				height: 100%;
				width: 100%;
			}

			#search, #part {
				position: absolute;

				top: 0;
				left: 0;

				width: 100%;
				height: 100%;

				overflow: auto;
				overflow-x: hidden;
			}
		</style>
	</head>

	<body class="padding-tbar">
		<div id="main">
			<div id="platform"></div>
			<div id="part"></div>
			<div id="search">
				<!-- <div class="header">
					<div class="ui breadcrumb" style="margin-top: 20px;">
						<div class="active section"></div>
					</div>
				</div> -->
				<div id="search-cont"></div>
			</div>
		</div>

		<div id="main-loader" class="uix active large loader">
			<svg class="circle" viewBox="20 20 60 60">
				<circle class="path" cx="50" cy="50" r="20" fill="none" stroke-width="12" stroke-miterlimit="10"/>
			</svg>
		</div>

		<!-- <div id="frame" style="height: 100px; width: 200px; background: white;"></div> -->

		<!-- <div class="frame", style="width: 100%; height: 100%; position: fixed; top: 0; left: 0; background: #FFF;"></div> -->

		<script>
			if (foci.nested) {
				$("html").addClass("foci-nested");
			}
		
			require([ "com/captcha" ], function (captcha) {
				foci.captcha(captcha.wrap); // set captcha event
			});
		
			require([
				"com/tbar", "com/event", "com/env",
				"com/util", "com/pages", "com/parts",
				"com/lang", "com/formi", "com/pm",
				"com/map", "lib/fastclick", "com/dragi",
				"com/club"
			], function (tbar, event, env, util, pages, parts, lang, formi, pm, map, fastclick, dragi, club) {
				// fastclick.attach(document.body);

				lang.loadDict("english", util, function () {
					lang.update(document.body);
				});

				// map.search();
				// uh.modal();

				// var cover = [ "img/cover1.jpg", "img/cover2.jpg", "img/cover3.jpg" ].choose();
				// $("#cover").css("background-image", "url(" + cover + ")");
				
				// init dragi platform
				if (!foci.nested) {
					foci.platform = dragi.platform("#platform");
					// dragi.window(foci.platform);
					// $("<div style='width: 500px; height: 500px; background: black'></div>").dragi();
				} else {
					foci.platform = top.foci.platform;
				}
				
				foci.use_dragi = true && !util.isMobile();

				env.init(function () {
					// map.init();
					// console.log(lang.expand("hola"));
					
					// club.popview({ use_dragi: true });

					var bar = tbar.init();
					
					if (foci.nested) {
						bar.hide();
						// $("body").removeClass("padding-tbar");
					}

					bar.menu(function () {
						util.jump("#cover");
					});

					bar.profile(function () {
						util.jump("#profile");
					});

					// util.scrollTop("#search", function () {
					// 	bar.removeShadow();
					// });

					util.scroll("#search, #part", function (n) {
						if (n > 0) {
							bar.showBanner();
							// bar.applyShadow();
						} else {
							bar.hideBanner();
						}
					}, undefined, undefined, foci.config.banner_min_scroll);

					// var cover_loaded = false;
					var pg = pages.init({
						"search": {
							page: "#search",
							onShow: function () {
								bar.setTitle("Search");
								bar.setStyle("shadowy");
							}
						},

						// "cover": {
						// 	page: "#cover",
						// 	onShow: function () {
						// 		bar.setTitle("Foci");
						// 		bar.setStyle("light-simple");
						// 	},

						// 	onLoad: function (show) {
						// 		if (cover_loaded) {
						// 			show();
						// 		} else {
						// 			$("#cover").off("ready").ready(function () {
						// 				setTimeout(function () {
						// 					$("#main-loader").removeClass("active");
						// 					show();
						// 					cover_loaded = true;
						// 				}, 2000);
						// 			});
						// 		}
						// 	}
						// },

						"part": {
							page: "#part",
							onShow: function () {
								bar.setStyle("");
							}
						},
					}, { init: "search" });

					var pt = parts.init("#part", {
						penv: {
							part: $("#part")
						},
						
						forced_refresh: [ "search", "profile" ],
						// forced to refresh even only the argument changed
						
						onJump: function (name, args) {
							bar.hideBanner();
							$("body").addClass("padding-tbar");

							// alert(args[0]);

							switch (name) {
								case "":
									util.jump("#cover");
									break;

								case "search":
									bar.showSearch();
									$("#main-loader").removeClass("active");

									// format: #search/<kw>/tag1,tag2,tag3
									var query = { kw: "" };

									if (args[0]) {
										query.kw = args[0];
									}

									if (args[1]) {
										query.favtag = args[1].split(",");
									}
									
									if (args[2]) {
										query.after = args[2];
									}
									
									if (args[3]) {
										query.before = args[3];
									}

									// console.log(query);

									research(query);
									return true;

								default:
									bar.setStyle("");
									bar.showSearch();
									$("#main-loader").removeClass("active");
									pg.to("part");
							}
						}
					});

					var ev = event.init("#search>#search-cont", {
						onUpdate: function (pos) {},
						fetch: {
							fetch: function (skip, sortby, cb) {
								foci.get("/event/search", $.extend({ skip: skip }, cur_query, sortby), cb);
							},

							cont: "#search",
							no_more_prompt: "no more results"
						},

						loader_only_on_buffer: true
					});

					env.store("tbar", bar);
					env.store("part", pt);

					bar.search(function (query, cb) {
						// research(query, cb);
						util.jump("#search/" + query.kw + "/" + (query.favtag ? query.favtag.join(",") : ""));
					});

					// re-search
					function research(query) {
						pg.to("search");
						bar.showSearchLoad();

						ev.clear(function () {
							bar.setTitle("Search results", (query.kw || "(empty)") + ", " + (query.favtag || "all"));

							$("#search").scrollTop(0);
							cur_query = query;
							
							ev.hide();
							ev.fetch(function () {
								bar.hideSearchLoad();
								ev.show();
							});
						});
					}
				});
			});
		</script>
	</body>
</html>
