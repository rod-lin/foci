<div class="sub-profile">
	<div class="left-bar">
		<div class="avatar-box">
			<div class="avatar empty">
				<div class="avatar-setting"><i class="fitted setting icon"></i></div>
			</div>
		</div><br>
		<div class="dname"></div><div class="realname-badge"></div><br>
		<div class="rating"></div><br>
		<div class="intro"></div><br>
		<!-- <div class="ui grey statistic">
			<div class="value follows">
				--
			</div>
			<div class="label">
				Follows
			</div>
		</div>
		<div class="ui grey statistic">
			<div class="value followers">
				--
			</div>
			<div class="label">
				Followers
			</div>
		</div><br> -->
		<div class="ui divider"></div>
		<div class="favtag">
			<div class="favtag-prompt"></div>
		</div>
		<div class="profile-util-box">
			<div class="profile-util no-login-only chat-btn"><i class="fitted comments outline icon"></i></div>
			<div class="profile-util login-only setting-btn"><i class="fitted setting icon"></i></div>
		</div>
	</div>
	<div class="right-bar">
		<div class="main-tab"></div>
	</div>

	<div class="new-event-draft" style="display: none;">
		<div class="new-event">
			<div class="ev-step">
				<div class="ui vertical fluid steps right-bar-left-step"></div>
			</div>
			<div class="ev-content">
				<!-- <div id="sub-profile-map" class="map"></div> -->
				<div class="page page-info active">
					<input class="ev-title input-no-style lang" data-replace="$front.sub.profile.new.title" data-attr="placeholder" placeholder="Title">
					<!-- textarea class="ev-descr input-no-style lang" data-replace="$front.sub.profile.new.descr" data-attr="placeholder" placeholder="Description"></textarea -->
					<div class="ev-descr"></div>
				</div>
				<div class="page page-cover" style="text-align: center; overflow: auto;"></div>
				<div class="page page-loc need-width">
					<div class="map" style="height: 100%;"></div>
					<div style="text-align: center; position: absolute; top: 0; width: 100%; margin-top: 0.6rem; pointer-events: none;">
						<div class="ui compact black inline message" style="min-width: 50%; max-width: 95%; pointer-events: auto;">

							<style>
								.sub-profile .loc-search-btn {
									float: right;
									display: inline-block;
									cursor: pointer;
								}
							</style>

							<div class="loc-selected" style="display: inline-block;"></div>
							<div class="loc-search-btn"><i class="search icon"></i></div>
						</div>
					</div>
				</div>
				<div class="page page-time pad" style="text-align: left; overflow-x: hidden;">
					<style>

						.sub-profile .page-time>span {
							display: inline-block;

							width: 100%;
							padding: 1rem;

							text-align: center;

							font-weight: bold;
							font-size: 1.2rem;
							border: 1px solid rgba(0, 0, 0, 0.1);
							border-radius: 3px 3px 0 0;
							border-bottom-width: 0;
						}

						.sub-profile .page-time>.calendar {
							margin-bottom: 1rem;
							overflow: auto;
						}

						.sub-profile .page-time>.calendar table {
							border-radius: 0 0 3px 3px !important;
						}

					</style>
					<span class="lang" data-replace="$front.sub.profile.start_date" style="">Start date</span>
					<div class="ui calendar ev-start-date"></div>
								<!-- </div>
								<div class="field"> -->
					<span class="lang" data-replace="$front.sub.profile.end_date">End date</span>
					<div class="ui calendar ev-end-date"></div>
								<!-- </div>
							</div>
						</div>
					</form> -->
				</div>
				<div class="page page-pay" style="text-align: center;">
				</div>
				<div class="page page-apply pad" style="text-align: left; overflow: auto;">
					<style>
						.sub-profile .page.page-apply .header,
						.sub-profile .page.page-apply label,
						.sub-profile .page.page-apply b,
						.sub-profile .page.page-apply span {
							color: rgba(70, 70, 70, 1) !important;
						}
						
						.sub-profile .page.page-apply p {
							margin-bottom: 0.5rem;
						}
					</style>
					<form class="ui form">
						<h3 class="ui top attached header lang" data-replace="$front.sub.profile.enable_app">Enable application</h3>
						<div class="ui attached segment">
							<div class="ui toggle checkbox enable-app-check">
								<input type="checkbox" name="public">
								<label>Start application process</label>
							</div>
						</div>

						<h3 class="ui top attached header lang" data-replace="$front.sub.profile.app_form">Application Forms</h3>
						<div class="ui attached segment">
							<div class="fields">
								<div class="field">
									<label class="lang" data-replace="$front.sub.profile.staff_form">Staff Form</label>
									<button class="ui basic blue button create-staff-form lang" data-replace="$front.sub.profile.create_edit" type="button">Create/Edit</button>
								</div>
								<div class="field">
									<label class="lang" data-replace="$front.sub.profile.partic_form">Participant Form</label>
									<button class="ui basic green button create-partic-form lang" data-replace="$front.sub.profile.create_edit" type="button">Create/Edit</button>
								</div>
							</div>
						</div>
						
						<h3 class="ui top attached header lang" data-replace="$front.sub.profile.organize">Manage</h3>
						<div class="ui attached segment">
							<div class="field">
								<p>
									<b class="lang" data-replace="$front.sub.profile.app_cent">Application Center</b><br>
									<span>
										View applicants for participants and staff.
									</span>
								</p>
								<button class="ui basic blue button goto-app-cent" type="button">Open</button>
							</div>
							<div class="field">
								<p>
									<b>End Event</b><br>
									<span>
										End the event to enable comment and rating.
									</span>
								</p>
								<button class="ui basic button goto-termev" type="button">End</button>
							</div>
						</div>

						<h3 class="ui top attached header lang" data-replace="$front.sub.profile.limitation">Limitations</h3>
						<div class="ui attached segment">
							<div class="fields">
								<div class="field">
									<label class="lang" data-replace="$front.sub.profile.max_staff">Max Staff</label>
									<input class="staff_limit lang" data-replace="$front.sub.profile.new.no_limit_in_def" data-attr="placeholder" type="text" placeholder="No limit in default">
								</div>
								<div class="field">
									<label class="lang" data-replace="$front.sub.profile.max_partic">Max Participant</label>
									<input class="partic_limit lang" data-replace="$front.sub.profile.new.no_limit_in_def" data-attr="placeholder" type="text" placeholder="No limit in default">
								</div>
							</div>
						</div>
					</form>
				</div>
				<div class="page page-detail pad" style="text-align: left;">
					<form class="ui form">
						<h3 class="ui top attached header lang" data-replace="$front.sub.profile.detail">Details</h3>
						<div class="ui attached segment">
							<div class="field">
								<p>
									<b class="lang" data-replace="$front.sub.profile.trivial_notice">Trivial tips</b><br>
									<span class="lang" data-replace="$front.sub.profile.trivial_notice_prompt">This notice will be shown on the event page</span>
								</p>
								<div class="ev-detail"></div>
							</div>
						</div>
					</form>
				</div>
				<div class="page page-pub" style="text-align: center;">
					<div class="protocol">
						<style>

							.sub-profile .new-event .ev-content .page-pub .protocol {
								padding: 0 2rem;
								height: 100%;
							}

							.sub-profile .new-event .ev-content .page-pub .protocol .prompt {
								font-size: 2em;
								margin-bottom: 1rem;
								margin-top: -5rem;
							}

						</style>
						<div class="vcenter" style="display: inline-block;">
							<div class="prompt"></div>
							<div class="ui basic primary button publish-btn">Submit</div>
						</div>
					</div>
				</div>
				<div class="page page-other pad" style="text-align: left; overflow: auto;">
					<h3 class="ui top attached header lang" data-replace="$front.sub.profile.change_event_state">
						Change event state
					</h3>
					<div class="ui attached segment">
						<p>
							<b class="lang" data-replace="$front.sub.profile.delete_event">Delete this event</b><br>
							<span class="lang" data-replace="$front.sub.profile.delete_event.prompt">
								ALL data will be lost. Only draft event can be deleted.<br>
								If you want to delete a public event, please contact us for human assistance.
							</span>
						</p>
						<div class="ui field">
							<button class="ui red basic button delete-event-btn lang" data-replace="$front.sub.profile.delete">Delete</button>
							<button class="ui basic button lang" data-replace="$front.sub.profile.help">Help</button>
						</div>
					</div>
					<div class="ui attached segment admin-review-block">
						<p>
							<b class="lang" data-replace="$front.sub.profile.unpublish">Unpublish</b><br>
							<span class="lang" data-replace="$front.sub.profile.unpublish_prompt">
								Change this event to draft state.<br>
								All info will be saved, but other users will not be able to view this event.
							</span>
						</p>
						<div class="ui field">
							<button class="ui blue basic button unpublish-btn lang" data-replace="$front.sub.profile.unpublish">Unpublish</button>
						</div>
					</div>
					<div class="ui attached segment admin-review-block">
						<p>
							<b class="lang">Publish</b><br>
							<span class="lang">
								Review passed. Publish this event.
							</span>
						</p>
						<div class="ui field">
							<button class="ui blue basic button admin-publish-btn lang">Publish</button>
						</div>
					</div>
					<div class="ui attached segment admin-review-block">
						<p>
							<b class="lang">Notice</b><br>
							<span class="lang">
								Send notice to the organizer.
							</span>
						</p>
						<div class="ui field">
							<button class="ui green basic button admin-notice-btn lang">Write</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<style>
	.sub-profile {
		height: 100%;
	}

	.sub-profile .left-bar {
		position: fixed;
		width: 20em;
		height: 100%;

		padding: 0 2rem;

		background: rgba(253, 253, 253, 0.7);
		border-right: 1px solid rgba(0, 0, 0, 0.08);

		text-align: center;

		overflow: auto;
	}

	.sub-profile:not(.logged) .left-bar .login-only {
		display: none;
	}

	.sub-profile.logged .left-bar .no-login-only {
		display: none;
	}

	.sub-profile .left-bar .profile-util-box {
		display: block;

		position: absolute;
		right: 0.7rem;
		top: 0.7rem;
		font-size: 1.3em;
		opacity: 0.6;

		cursor: pointer;
	}

	.sub-profile .left-bar .profile-util {
		display: inline-block;
		margin-left: 0.5rem;
	}
	
	.sub-profile .left-bar .avatar-box {
		position: relative;
		display: inline-block;
		
		width: 9em;
		height: 9em;
		margin-top: 4em;
	}

	.sub-profile .left-bar .avatar {
		border-radius: 50%;
		overflow: hidden;

		background-image: url("img/matt.jpg");

		background-repeat: no-repeat;
		background-size: cover;
		background-position: 50% 50%;

		box-shadow:
			0 0 1px rgba(0, 0, 0, 0.2),
			0 0 16px rgba(0, 0, 0, 0.03);

		transition: box-shadow 0.3s;
	}
	
	.sub-profile .left-bar .realname-badge {
		display: inline-block;
		
		height: auto;
		width: auto;
		
		margin-left: 0.3rem;
		
		cursor: pointer;
		
		font-size: 1.5rem;
	}

	.sub-profile .left-bar .avatar:hover {
		box-shadow:
			0 0 1px rgba(0, 0, 0, 0.2),
			0 0 10px rgba(0, 0, 0, 0.08);
	}

	.sub-profile .left-bar .avatar.empty {
		background: rgba(0, 0, 0, 0.2);
	}

	.sub-profile .left-bar .avatar .avatar-setting {
		display: none;
	}

	.sub-profile.logged .left-bar .avatar .avatar-setting {
		display: block;

		color: #F3F3F3;
		font-weight: bold;
		opacity: 0;
		line-height: 9rem;
		font-size: 1.5em;
		text-align: center;

		width: 100%;

		cursor: pointer;
		background: rgba(0, 0, 0, 0.2);

		transition: opacity 0.5s;
	}

	.sub-profile.logged .left-bar .avatar.explicit div,
	.sub-profile.logged .left-bar .avatar:hover div {
		opacity: 0.7;
	}

	.sub-profile.logged .left-bar .avatar:hover div:active {
		opacity: 1;
	}

	.sub-profile .left-bar .dname {
		display: inline-block;

		font-size: 2em;
		font-weight: bold;

		padding: 0.3rem 0.3rem;
		margin: 1rem 0 0 0;

		max-width: 100%;
		word-wrap: break-word;

		color: #262626;
	}

	.sub-profile .left-bar .rating {
		margin: 0.5rem 0 0 0;
	}

	.sub-profile .left-bar .intro {
		display: inline-block;

		margin: 0.5rem 0 0.5rem 0;
		padding: 1rem 1rem;

		max-width: 100%;
		word-wrap: break-word;

		color: #999999;
	}

	.sub-profile .left-bar .favtag {
		width: 100%;
		padding-top: 1rem;
		margin-bottom: 1rem;
	}

	.sub-profile .left-bar .favtag-prompt {
		color: #CCCCCC;
		font-weight: bold;
	}

	.sub-profile .right-bar {
		position: relative;
		margin-left: 20em;
		height: 100%;
	}

	.sub-profile .right-bar.main-tab {
		height: 100%;
	}

	@media only screen and (max-width: 767px) {
		.sub-profile .left-bar {
			position: relative;
			height: auto;
			width: 100%;
			padding-bottom: 2rem;
			border-width: 0 0 1px 0;
		}

		.sub-profile .left-bar .favtag {
			padding-right: 1rem;
			padding-left: 1rem;
		}

		.sub-profile .left-bar .profile-util-box {
			right: 1.1rem;
			top: 1.1rem;
			font-size: 1.5rem;
		}

		.sub-profile .right-bar {
			margin-left: 0;
			border-top: 1px solid rgba(0, 0, 0, 0.08);
		}

		.sub-profile .right-bar .right-bar-left-step {
			overflow: auto;
		}
	}

	.sub-profile .new-event .ev-content {
		position: absolute;
		width: 70%;

		top: 0;
		left: 30%;

		border: 1px solid rgba(0, 0, 0, 0.08);
		border-width: 0 0 0 1px;
	}

	.sub-profile .new-event .ev-step {
		position: absolute;
		width: 30%;

		top: 0;
		left: 0;
	}

	.sub-profile .new-event .ev-title {
		width: 100%;
		padding: 2rem;
		background: white;
		color: #252525;

		font-size: 2em;
		font-weight: bold;

		border: 1px solid rgba(0, 0, 0, 0.08);
		border-width: 0 0 1px 0;
	}

	/* .sub-profile .new-event .ev-descr {
		width: 100%;
		padding: 2rem;
		background: white;
		color: #252525;

		font-size: 1.5em;
	} */

	.sub-profile .new-event .ev-detail {
		height: 20rem;
		border: 1px solid rgba(0, 0, 0, 0.08);
		border-radius: 3px;
		overflow: hidden;
	}

	.sub-profile .new-event .ui.steps {
		border-width: 0 0 1px 0 !important;
		border-radius: 0 !important;
	}

	.sub-profile .new-event .ui.steps .step {
		border-radius: 0 !important;

		display: -webkit-flex !important;
		display: flex !important;

		-webkit-box-align: center;
		-ms-flex-align: center;
		align-items: center;
	}

	.sub-profile .new-event .ui.steps .step .icon {
		display: inline-block;
		width: 4rem;
		color: #323232;
	}

	.sub-profile .new-event .ui.steps .step .content {
		flex: 1 !important;
		flex-grow: 1;
		flex-shrink: 1;
		flex-basis: 0;
		overflow: hidden;
	}

	.sub-profile .new-event .ui.steps .step .content .title {
		overflow: hidden;
		text-overflow: ellipsis;
	}

	.sub-profile .new-event .ev-content .page {
		display: none;
	}

	.sub-profile .new-event .ev-content .page.need-width {
		display: block;
		visibility: hidden;

		position: absolute;
		top: 0;
		left: 0;

		width: 100%;
	}

	.sub-profile .new-event .ev-content .page.pad {
		padding: 2rem;
	}

	.sub-profile .new-event .ev-content .page.active {
		display: block;
	}

	.sub-profile .new-event .ev-content .page.need-width.active {
		visibility: visible;

		position: static;
	}

	.sub-profile .new-event .ev-content .warning {
		background: #FFF6F6;
		color: #9F3A38;
	}

	.ui.steps .step.active .title {
		color: rgba(0, 0, 0, .87) !important;
	}

	@media only screen and (max-width: 1024px) {
		.sub-profile .new-event .ui.steps .step .content .description {
			display: none;
		}
	}

	@media only screen and (max-width: 640px) {
		.sub-profile .new-event .ev-content {
			left: 18%;
			width: 82%;
		}

		.sub-profile .new-event .ev-step {
			width: 18%;
		}

		.sub-profile .new-event .ev-step .description {
			display: none;
		}

		.sub-profile .new-event .ev-title {
			padding: 1.4rem;
			font-size: 1.5em;
		}

		/* .sub-profile .new-event .ev-descr {
			padding: 1.4rem;
			font-size: 1.2em;
		} */

		.sub-profile .new-event .ev-step .step {
			font-size: 0.7em;
			padding: 1rem 1rem;
		}

		.sub-profile .new-event .ev-step .step .icon {
			margin-bottom: 0.1em;
		}
		
		.sub-profile .new-event .ev-step .step .title {
			font-size: 0.8rem;
		}

		.sub-profile .new-event .ev-content .page.pad {
			padding: 1rem;
		}
	}
</style>

<script>
	function init(main, args, show, cont, exit, penv) {
		require([
			"com/env", "com/util", "com/event",
			"com/xfilt", "com/pages", "com/tab",
			"com/login", "com/event", "com/upload",
			"com/map", "com/lang", "com/editable",
			"com/tagbox", "com/pm", "com/tip",
			"com/formi", "com/marki", "com/resume",
			"com/helper", "com/notice", "com/rating",
			"com/realname"
		], function (
			env, util, event, xfilt,
			pages, tab, login, event,
			upload, map, lang, editable,
			tagbox, pm, tip, formi, marki,
			resume, helper, notice, rating,
			realname
		) {
			var init = function (info, is_self, init_page, page_arg) {
				// foci.get("/user/resume", {
				// 	uuid: info.uuid
				// }, function (suc, dat) {
				// 	if (suc) {
				// 		console.log(dat);
				// 	} else {
				// 		util.emsg(dat);
				// 	}
				// });

				var tbar = env.get("tbar");
				var pt = env.get("part");

				tbar.setTitle("Profile", info.dname);

				var left_bar = main.find(".left-bar");
				var right_bar = main.find(".right-bar");

				var m = lang.msg;
				var i = lang.inline;

				left_bar.find(".dname").html(util.fill());
				left_bar.find(".intro").html(util.fill());

				left_bar.find(".follows").html("--");
				left_bar.find(".followers").html("--");

				// left_bar.find(".rating").rating("disable").rating("set rating", 0);
				var rat = rating.init(left_bar.find(".rating"), 0);

				var tgbox = null;

				function setDom(info) {
					var parsed = login.parseInfo(info);

					util.ratingOf(info.uuid, function (rating) {
						// left_bar.find(".rating").rating("set rating", Math.round(rating / 2));
						rat.set(rating);
					});

					left_bar.find(".dname").html(parsed.dname);
					left_bar.find(".intro").html(parsed.intro);
					left_bar.find(".avatar").css("background-image", "url('" + parsed.avatar + "')").removeClass("empty");

					left_bar.find(".realname-badge").append(realname.badge(info.uuid, null, {
						only_state: true,
						show_norealname: true
					}));

					if (!tgbox) {
						env.favtag(function (tags) {
							tgbox = tagbox.init(left_bar.find(".favtag"), tags, {
								init: parsed.favtag,
								onChange: function (tags) {
									updateAllPos();
									login.session(function (session) {
										foci.encop(session, {
											int: "info",
											action: "set",
											favtag: tags
										}, function (suc, dat) {
											if (suc) {
												info.favtag = tags;
												setDom(info);
											} else {
												util.emsg(dat);
											}
										});
									});
								}
							});

							if (is_self)
								tgbox.openEdit();
						});
					} else {
						tgbox.set(parsed.favtag, true);
					}

					if (!parsed.favtag.length && !is_self) {
						left_bar.find(".favtag-prompt").html("no interest");
					} else {
						left_bar.find(".favtag-prompt").html("");
					}
				}

				var ev_list = {};

				function eventTabOnShow(name, enc, view, config, cb) {
					var next = function (suc) {
						ev_list[name].update();
						setTimeout(function () {
							updateAllPos(); // update pos after loading(because the scroll bar may appear)
							cb();
						}, 300);
					};

					updateAllPos();

					if (!ev_list[name]) {
						ev_list[name] = event.init(tb.getTab(name), $.extend({
							view: view,
							fetch: {
								fetch: function (skip, sortby, cb) {
									if (enc) {
										login.session(function (session) {
											foci.encop(session, $.extend({
												int: "event",
												action: name,
												skip: skip
											}, sortby), cb);
										});
									} else {
										foci.get("/user/" + name, $.extend({ uuid: info.uuid, skip: skip }, sortby), cb);
									}
								},

								cont: cont,
								no_more_prompt: m("$front.sub.profile.no_more_result")
							}
						}, config));
					}

					ev_list[name].clear(function () {
						ev_list[name].fetch(next);
					});
				}

				var org_tab_tip_proc;
				var tabs = {
					"applied": {
						order: 1,
						name: m("$front.sub.profile.applied").capital(),
						onShow: function (show) {
							tbar.setTitle("Profile", info.dname, "Applied");
							eventTabOnShow("applied", false, undefined, null, show);
						}
					},

					"org": {
						order: 2,
						name: m("$front.sub.profile.organized").capital(),
						
						onChange: function () {
							if (org_tab_tip_proc) {
								clearTimeout(org_tab_tip_proc);
								org_tab_tip_proc = null;
							}
						},
						
						onShow: function (show) {
							tbar.setTitle("Profile", info.dname, "Organized");
							eventTabOnShow("org", false, undefined, {
								ext_button: [
									{
										class: "setting vuid-profile-org-event-setting",
										onClick: function (info) {
											loadDraft(info);
											tb.to("new");
										}
									},

									{
										class: "sitemap vuid-profile-org-event-appcent",
										onClick: function (info) {
											util.jump("#appcent/" + info.euid);
										}
									}
								]
							}, show);

							if (is_self) {
								if (org_tab_tip_proc) clearTimeout(org_tab_tip_proc);
								org_tab_tip_proc = setTimeout(function () {
									org_tab_tip1 = tip.init(main.find(".vuid-profile-org-event-setting")[0], "Setting is here", "top center", {
										scroll: penv.part
									});

									org_tab_tip2 = tip.init(main.find(".vuid-profile-org-event-appcent")[0], "Application center", "bottom center", {
										scroll: penv.part
									});
								}, 1000);
							}
						}
					}
				};

				var new_tab = main.children(".new-event-draft").children();

				new_tab.find(".ev-title").keyup(function () {
					$(this).removeClass("warning");
				});

				// new_tab.find(".ev-descr").keyup(function () {
				// 	$(this).removeClass("warning");
				// });

				var editor_descr = marki.editor(new_tab.find(".ev-descr"), {
					placeholder: m("$front.sub.profile.new.descr")
				});

				editor_descr.focus(function () {
					util.localOnce("sub-profile-descr-editor", editor_descr.showHelp);
				});
				
				var editor_detail = marki.editor(new_tab.find(".ev-detail"), {});

				/*
					To add a step, you need to:
						1. Add a step item in the .ev-step
						2. Add a page in the .ev-content
						3. Add the step name in the "steps" array below
						4. Add check and show event in "step_show" and "step_check"
						5. Add initialization code in loadDraft
				 */

				"use strict";

				var loadDraft, clearDraft, hasDraft, saveDraft, deleteEmptyDraft;
				var setDraftStep;
				var published;

				function initDraft() {
					var euid = null;
					// var steps = [ "info", "cover", "loc", "pub" ];
					var cur_step = "info";
					var bmap = null;
					var fields;

					var changed = {};

					var deleted = false;

					function isEmptyDraft() {
						if (fields.state) return false;

						for (var k in changed) {
							if (changed.hasOwnProperty(k) && changed[k])
								return false;
						}

						for (var k in fields) {
							if (fields.hasOwnProperty(k) && fields[k] &&
								(fields[k].length === undefined || fields[k].length)) {
								// console.log(fields[k].length);
								return false;
							}
						}

						return true;
					}

					function deleteEvent(euid, cb) {
						login.session(function (session) {
							foci.encop(session, {
								int: "event",
								action: "del",
								euid: euid
							}, function (suc, dat) {
								if (!suc) {
									util.emsg(dat);
								}

								if (cb) cb(suc);
							});
						});
					};

					deleteEmptyDraft = function (cb) {
						if (deleted) {
							cb(true);
							return;
						}

						if (isEmptyDraft()) {
							deleteEvent(euid, function () {
								cb(true);
							});
						} else {
							cb(false);
						}
					};

					var steps = {
						info: {
							title: i("$front.sub.profile.new.info"),
							icon: "info",
							subtitle: i("$front.sub.profile.new.info_subtitle"),

							page: main.find(".page.page-info"),
							next: "cover",

							onShow: function () {
								main.ready(function () {
									updateAllPos();
								});
							},

							onInit: function (info) {
								fields.title = info.title ? info.title : "";
								fields.descr = info.descr ? info.descr : "";

								tb.getItem("new").html(m("$front.sub.profile.save"))
									.off("click", nextStep); // avoid duplication

								util.nextTick(function () { // avoid bubbling
									tb.getItem("new").on("click", nextStep);
								});

								var change = function () {
									changed.info = true;
								};

								// page 1
								new_tab.find(".ev-title").val(fields.title).off("change").change(change);
								// new_tab.find(".ev-descr").val(fields.descr).off("change").change(change);
								editor_descr.val(fields.descr).keyup(change);

								return fields.title && fields.descr;
							},

							onCheck: function (cb) {
								var suc = true;

								var has_title = !!new_tab.find(".ev-title").val();
								// var has_descr = !!new_tab.find(".ev-descr").val();
								var has_descr = !!editor_descr.val();

								if (!has_title && !has_descr) {
									cb(true);
									return;
								}

								if (!has_title) {
									new_tab.find(".ev-title").addClass("warning");
									suc = false;
								}

								if (!has_descr) {
									// new_tab.find(".ev-descr").addClass("warning");
									editor_descr.setWarning();
									suc = false;
								}

								if (suc) {
									if (changed.info) {
										uploadChanges({
											title: fields.title = new_tab.find(".ev-title").val(),
											// descr: fields.descr = new_tab.find(".ev-descr").val()
											descr: fields.descr = editor_descr.val()
										}, function (suc) {
											if (suc) {
												new_tab.find(".info-step").addClass("completed");
												cb(true);
											} else {
												cb(false);
											}
										});
									} else cb(true);
								} else cb(false);

								return;
							}
						},

						cover: {
							title: i("$front.sub.profile.new.cover"),
							icon: "camera retro card",
							subtitle: i("$front.sub.profile.new.cover_subtitle"),

							page: main.find(".page.page-cover"),
							next: "loc",

							onInit: function (info) {
								var event_tmp = event.eventTemplate(true);
								new_tab.find(".ev-content .page-cover").html(event_tmp);
								event_tmp
									.css("display", "inline-block")
									.css("text-align", "left")
									.css("max-width", "90%")
									.addClass("vcenter noext");

								// event_tmp.ready(function () {
								// 	var pg = main.find(".page.page-cover");

								// 	if (pg.height() < event_tmp.height()) {
								// 		vcent.reset(event_tmp);
								// 	}
								// });

								fields.cover = info.cover;
								fields.favtag = info.favtag;
								fields.logo = info.logo;
								
								var is_first = true;

								event.setDom(event_tmp, {
									title: info.title || fields.title,
									descr: info.descr || fields.descr,
									cover: info.cover,
									logo: info.logo,
									favtag: info.favtag
								}, {
									editTag: true,

									onCoverClick: function (dom) {
										upload.init(function (file) {
											if (file) {
												fields.cover = file;
												changed.cover = true;
												dom.changeCover(file);
											}
										});
									},

									onLogoClick: function (dom) {
										upload.init(function (file) {
											if (file) {
												fields.logo = file;
												changed.logo = true;
												dom.changeLogo(file);
											}
										});
									},

									onTagChange: function (tags) {
										if (is_first) is_first = false;
										else {
											fields.favtag = tags;
											changed.favtag = true;
										}
									},

									max_descr_len: 64,
									max_title_len: 32
								});

								return fields.cover && fields.logo;
							},

							onCheck: function (cb) {
								if (changed.cover || changed.logo || changed.favtag) {
									uploadChanges({
										cover: fields.cover || undefined,
										logo: fields.logo || undefined,
										favtag: fields.favtag || undefined
									}, function (suc) {
										if (suc) {
											new_tab.find(".cover-step").addClass("completed");
											cb(true);
										} else {
											cb(false);
										}
									});
								} else {
									cb(true);
								}
							}
						},

						loc: {
							title: i("$front.sub.profile.new.location"),
							icon: "map outline",
							subtitle: i("$front.sub.profile.new.location_subtitle"),

							page: main.find(".page.page-loc"),
							next: "time",

							onInit: function (info) {
								function set(lng, lat) {
									fields.lng = lng;
									fields.lat = lat;
								}

								set(info.loclng, info.loclat);

								new_tab.find(".loc-search-btn").off("click").click(function () {
									map.search(function (lng, lat, addr) {
										set(lng, lat);
										new_tab.find(".loc-selected").html(addr);
										bmap.set(lng, lat);
									});
								});

								new_tab.find(".loc-selected").html("Select a location on the map");

								if (!bmap) {
									new_tab.find(".ev-content .page-loc .map").ready(function () {
										map.embed(new_tab.find(".ev-content .page-loc .map"), function (map) {
											bmap = map;

											// TODO: temp fix!
											// if (display_mode == "mobile")
											// bmap.pan(0, main.parent().scrollTop());
											penv.part.scroll(function () {
												bmap.pan(0, penv.part.scrollTop());
											}).scroll();

											steps["loc"].onShow = function () {
												// bmap.init(); // init position

												tip.init(new_tab.find(".loc-search-btn"), "Click here to search!", "bottom center", { style: "white" });

												if (fields.lng && fields.lat) {
													bmap.set(fields.lng, fields.lat);
												} else {
													bmap.init();
													bmap.clear();
												}
											}
										}, {
											onClick: function (lng, lat, addr) { // called everytime a position is selected
												set(lng, lat);
												new_tab.find(".loc-selected").html(addr);
												// alert(lng + ", " + lat + ", " + addr);
											},

											onSelect: function (lng, lat, addr) {
												set(lng, lat);
												new_tab.find(".loc-selected").html(addr);
												nextStep();
											}
										});
									});
								}

								return fields.lng && fields.lat;
							},

							onCheck: function (cb) {
								if (fields.lng && fields.lat) {
									uploadChanges({
										loclng: fields.lng,
										loclat: fields.lat
									}, function (suc) {
										if (suc) {
											new_tab.find(".loc-step").addClass("completed");
											cb(true);
										} else {
											cb(false);
										}
									});
								} else {
									// util.ask(m("$front.sub.profile.no_selected($front.sub.profile.location)$front.sub.profile.period $front.sub.profile.sure_to_leave?").capital(), function (suc) {
									// 	if (suc) {
									// 		// new_tab.find(".loc-step").addClass("completed");
									// 		cb(true);
									// 	} else {
									// 		cb(false);
									// 	}
									// });
									cb(true);
								}
							}
						},

						time: {
							title: i("$front.sub.profile.new.time"),
							icon: "checked calendar",
							subtitle: i("$front.sub.profile.new.time_subtitle"),

							page: main.find(".page.page-time"),
							next: "apply",

							onInit: function (info) {
								new_tab.find(".ev-start-date").calendar("clear");
								new_tab.find(".ev-end-date").calendar("clear");

								if (info.start) {
									fields.start = new Date(info.start);
									new_tab.find(".ev-start-date").val("").calendar("set date", fields.start);
								}

								if (info.end) {
									fields.end = new Date(info.end);
									new_tab.find(".ev-end-date").val("").calendar("set date", fields.end);
								}

								return fields.start && fields.end;
							},

							onCheck: function (cb) {
								if (fields.start || fields.end) {
									uploadChanges({
										start: fields.start ? fields.start.getTime() : undefined,
										end: fields.end ? fields.end.getTime() : undefined
									}, function (suc) {
										if (suc) {
											new_tab.find(".time-step").addClass("completed");
											cb(true);
										} else {
											cb(false);
										}
									});
								} else {
									cb(true);
								}
							}
						},

						// pay: {
						// 	title: i("$front.sub.profile.new.payment"),
						// 	icon: "payment",
						// 	subtitle: i("$front.sub.profile.new.payment_subtitle"),
						// 
						// 	page: main.find(".page.page-pay"),
						// 	next: "apply",
						// },

						apply: {
							title: i("$front.sub.profile.new.applicant"),
							icon: "user outline",
							subtitle: i("$front.sub.profile.new.applicant_subtitle"),

							page: main.find(".page.page-apply"),
							next: "detail",

							onInit: function (info) {
								// fields.apply_staff_form = info.apply_staff_form;
								// fields.apply_partic_form = info.apply_partic_form;

								if (info.apply_open) {
									new_tab.find(".enable-app-check").checkbox("check");
								} else {
									new_tab.find(".enable-app-check").checkbox("uncheck");
								}

								info.apply_staff_form = util.json(info.apply_staff_form);
								info.apply_partic_form = util.json(info.apply_partic_form);

								// fields.apply_staff_lim = info.apply_staff_lim;
								// fields.apply_partic_lim = info.apply_partic_lim;

								if (info.apply_staff_form) {
									main.find(".create-staff-form").attr("data-replace", "$front.sub.profile.edit");
								} else {
									main.find(".create-staff-form").attr("data-replace", "$front.sub.profile.create");
								}

								if (info.apply_partic_form) {
									main.find(".create-partic-form").attr("data-replace", "$front.sub.profile.edit");
								} else {
									main.find(".create-partic-form").attr("data-replace", "$front.sub.profile.create");
								}

								lang.update(main.find(".page.page-apply"));

								if (info.apply_staff_lim) {
									main.find(".staff_limit").val(info.apply_staff_lim);

								}

								if (info.apply_partic_lim) {
									main.find(".partic_limit").val(info.apply_partic_lim);
								}

								var def_form = { name: "New Form", block: [] };

								main.find(".create-staff-form").off("click").click(function () {
									var nform = formi.modal(fields.apply_staff_form || info.apply_staff_form || def_form);
									nform.openEdit(function (saved) {
										fields.apply_staff_form = saved;
										main.find(".create-staff-form").attr("data-replace", "$front.sub.profile.edit");
										lang.update(main.find(".page.page-apply"));
									});
								});

								main.find(".create-partic-form").off("click").click(function () {
									var nform = formi.modal(fields.apply_partic_form || info.apply_partic_form || def_form);
									nform.openEdit(function (saved) {
										fields.apply_partic_form = saved;
										main.find(".create-partic-form").attr("data-replace", "$front.sub.profile.edit");
										lang.update(main.find(".page.page-apply"));
									});
								});

								return info.apply_open && info.apply_staff_form && info.apply_partic_form;
							},

							onCheck: function (cb) {
								var q = {};
								var has_field = false;

								if (fields.apply_staff_form) {
									q.apply_staff_form = JSON.stringify(fields.apply_staff_form);
									has_field = true;
								}

								if (fields.apply_partic_form) {
									q.apply_partic_form = JSON.stringify(fields.apply_partic_form);
									has_field = true;
								}

								var staff_limit = main.find(".staff_limit").val();
								var partic_limit = main.find(".partic_limit").val();
								var suc = true;

								if (staff_limit) {
									staff_limit = parseInt(staff_limit);
									if (isNaN(staff_limit)) {
										main.find(".staff_limit").parent().addClass("error");
										util.emsg("not number");
										suc = false;
									} else {
										fields.apply_staff_lim = q.apply_staff_lim = staff_limit;
										has_field = true;
									}
								}

								if (partic_limit) {
									partic_limit = parseInt(partic_limit);
									if (isNaN(partic_limit)) {
										main.find(".partic_limit").parent().addClass("error");
										util.emsg("not number");
										suc = false;
									} else {
										fields.apply_partic_lim = q.apply_partic_lim = partic_limit;
										has_field = true;
									}
								}

								if (changed.apply_open) {
									q.apply_open = new_tab.find(".enable-app-check").checkbox("is checked");
									has_field = true;
								}

								if (!suc) {
									cb(false);
									return;
								}

								if (has_field)
									uploadChanges(q, function (suc) {
										if (suc) {
											new_tab.find(".apply-step").addClass("completed");
											cb(true);
										} else {
											cb(false);
										}
									});
								else
									cb(true);
							}
						},

						detail: {
							title: i("$front.sub.profile.new.detail"),
							icon: "announcement",
							subtitle: i("$front.sub.profile.new.detail_subtitle"),

							page: main.find(".page.page-detail"),
							next: "pub",

							onInit: function (info) {
								fields.detail = info.detail;

								editor_detail
									.val(info.detail ? info.detail : "")
									.keyup(function () {
										changed.detail = true;
									});

								return !!fields.detail;
							},

							onCheck: function (cb) {
								if (changed.detail) {
									uploadChanges({
										detail: fields.detail = editor_detail.val()
									}, function (suc) {
										if (suc) {
											new_tab.find(".detail-step").addClass("completed");
											cb(true);
										} else {
											cb(false);
										}
									});
								} else cb(true);
							}
						},

						pub: {
							title: i("$front.sub.profile.new.publish"),
							icon: "send outline",
							subtitle: i("$front.sub.profile.new.publish_subtitle"),

							page: main.find(".page.page-pub"),

							onInit: function (info) {
								// reset publish message
								switch (info.state) {
									case foci.evstat.review:
										setPublishMsg(m("$front.sub.profile.under_review").capital());
										new_tab.find(".ev-content .protocol .publish-btn").addClass("disabled");
										published = true;
										break;
									
									default:
									case foci.evstat.draft:
										setPublishMsg(m("$front.sub.profile.submit_event_review").capital());
										new_tab.find(".ev-content .protocol .publish-btn").removeClass("disabled");
										published = false;
										break;
										
									case foci.evstat.published:
										setPublishMsg(m("$front.sub.profile.event_published").capital());
										new_tab.find(".ev-content .protocol .publish-btn").addClass("disabled");
										published = true;
										break;
										
									case foci.evstat.terminated:
										setPublishMsg(m("$front.sub.profile.event_terminated").capital());
										published = true;
										break;
								}

								return false;
							}
						},

						other: {
							title: i("$front.sub.profile.new.other"),
							icon: "warning circle",
							subtitle: i("$front.sub.profile.new.other_subtitle"),

							page: main.find(".page.page-other"),

							onInit: function (info) {
								main.find(".delete-event-btn").off("click").click(function () {
									util.ask(m("$front.sub.profile.delete_event_ask?"), function (ans) {
										if (ans) {
											deleteEvent(euid, function (suc) {
												if (suc) {
													deleted = true;
													util.emsg("$front.sub.profile.event_deleted");
													tb.to("draft");
												}
											});
										}
									});
								});
								
								function unpublish(euid) {
									login.session(function (session) {
										foci.encop(session, {
											int: "event",
											action: "unpublish",
											euid: euid
										}, function (suc, dat) {
											if (suc) {
												util.emsg("$front.sub.profile.event_unpublished", "info");
												main.find(".unpublish-btn").addClass("disabled");
											} else {
												util.emsg(dat);
											}
										});
									});
								}

								main.find(".unpublish-btn").off("click").click(function () {
									unpublish(euid);
								});
								
								login.session(function (session) {
									if (session.isAdmin()) {
										main.find(".admin-review-block").css("display", "");
										
										main.find(".admin-publish-btn").off("click").click(function () {
											foci.encop(session, {
												int: "event",
												action: "publish",
												euid: euid
											}, function (suc, dat) {
												if (suc) {
													util.emsg("event published", "info");
												} else {
													util.emsg(dat);
												}
											});
										});
										
										// send notice to the organizer
										main.find(".admin-notice-btn").off("click").click(function () {
											var org = info.org ? info.org[0] : uuid; // no org -> I created myself(why? no idea)
											var prompt = "To the <a href='#profile/" + org + "'>organizer</a>";
											
											notice.editor({
												prompt: prompt,
												is_admin: true,
												onSend: function (dat, cb) {
													foci.encop(session, {
														int: "notice",
														action: "send",
														type: "system",

														sender: dat.sender,
														uuids: [ org ],

														title: dat.title,
														msg: dat.msg
													}, function (suc, dat) {
														if (suc) {
															util.emsg("notice has been sent", "success");
														} else {
															util.emsg(dat);
														}

														cb(suc);
													});
												}
											});
										});
									} else {
										main.find(".admin-review-block").css("display", "none");
									}
								});
							}
						}
					};

					function setPublishMsg(msg) {
						new_tab.find(".ev-content .protocol .prompt").html(msg);
					}

					/* loader icon on the New/Save button */
					function setLoader() {
						tb.getItem("new").html("<div class='ui active inverted " + (
							display_mode == "normal"
							? "small" : "tiny"
						) + " inline loader'></div>");
					}

					function delLoader() {
						tb.getItem("new").html(m("$front.sub.profile.save"));
					}

					// save the current changes
					function uploadChanges(changes, cb) {
						login.session(function (session) {
							setLoader();

							foci.encop(session, $.extend({
								int: "event",
								action: "setinfo",
								euid: euid
							}, changes), function (suc, dat) {
								delLoader();

								if (!suc) {
									util.emsg(dat);
								}

								cb(suc);
							});
						});
					}

					function checkStep(cb) {
						var check = steps[cur_step].onCheck;
						if (check) {
							check(cb);
						} else cb(true);
					}

					function setStep(step, nocheck) {
						var next = function (cast) {
							if (cast === false) return;

							// some settings to remove active page and cast to the new one
							new_tab.find(".ev-content .page.active").removeClass("active");
							new_tab.find(".ev-step .active").removeClass("active");
							new_tab.find("." + step + "-step").addClass("active");
							steps[step].page.addClass("active");

							cur_step = step;

							var show = steps[step].onShow;
							if (show) show();
						};

						if (nocheck) next();
						else checkStep(next);
					}

					// step initalize
					function initStep() {
						function set(select, page) {
							// alert("bond " + select + ", " + page);
							new_tab.find(select).on("click", function () {
								setStep(page);
							});
						}

						// init all step tags
						for (var k in steps) {
							if (steps.hasOwnProperty(k)) {
								var step = $(' \
									<div class="link step ' + k + '-step"> \
										<i class="' + steps[k].icon + ' icon"></i> \
										<div class="content"> \
											<div class="title"></div> \
											<div class="description"></div> \
										</div> \
									</div> \
								');

								step.find(".title").html(steps[k].title);
								step.find(".description").html(steps[k].subtitle);

								new_tab.find(".ev-step .steps").append(step);
								set(step, k);
							}
						}
					}

					function nextStep() {
						var next = steps[cur_step].next;

						if (next) {
							setStep(next);
						} else {
							checkStep(function () {});
						}
					}

					setDraftStep = function (name) {
						if (!steps.hasOwnProperty(name)) {
							util.emsg("illegal setting page");
						} else
							setStep(name, true);
					};

					clearDraft = function () {
						euid = null;
						deleted = false;
						changed = {};

						tb.getItem("new").off("click", nextStep);
						tb.getItem("new").html(m("$front.sub.profile.new"));
						main.find(".unpublish-btn").removeClass("disabled");
						fields = {};
						// new_tab.find(".ev-step .step").off("click");
					};

					hasDraft = function () {
						return euid != null;
					};

					saveDraft = function (cb) {
						setLoader();
						checkStep(function (suc) {
							delLoader();
							cb(suc);
						});
					};

					loadDraft = function (info, cb) {
						if (!info || !info.euid) {
							util.emsg("$impossible(euid not given)");
							return;
						} // make sure the event has been created

						updateNewEventPos(); // update position

						euid = info.euid;

						fields = {};

						if (info.state)
							fields.state = info.state;

						var last = null;

						// init all steps with new event info
						for (var k in steps) {
							if (steps.hasOwnProperty(k)) {
								if (steps[k].onInit) {
									var finished = steps[k].onInit(info);
									if (finished) {
										new_tab.find("." + k + "-step").addClass("completed");
									} else {
										if (!last) last = k;
										new_tab.find("." + k + "-step").removeClass("completed");
									}
								}
							}
						}

						setStep(last || "pub", true);

						if (cb) cb();
					};

					initStep();

					// publish button onclick
					new_tab.find(".ev-content .protocol .publish-btn").click(function () {
						var btn = $(this);

						btn.addClass("loading");

						login.session(function (session) {
							foci.encop(session, {
								int: "event",
								action: "setreview",
								euid: euid
							}, function (suc, dat) {
								btn.removeClass("loading");

								if (suc) {
									btn.addClass("disabled");
									main.find(".unpublish-btn").removeClass("disabled");
									published = true;
									setPublishMsg(m("$front.sub.profile.under_review").capital());
								} else {
									util.emsg(dat);
								}
							});
						});
					});

					new_tab.find(".ev-start-date").calendar({
						type: "date",
						inline: true,
						endCalendar: new_tab.find(".ev-end-date"),
						onChange: function (date) {
							setTimeout(function () {
								new_tab.find(".ev-end-date").calendar("refresh");
							}, 0);
							fields.start = date;
						}
					});

					new_tab.find(".ev-end-date").calendar({
						type: "date",
						inline: true,
						startCalendar: new_tab.find(".ev-start-date"),
						onChange: function (date) {
							setTimeout(function () {
								new_tab.find(".ev-start-date").calendar("refresh");
							}, 0);
							fields.end = date;
						}
					});

					new_tab.find(".enable-app-check").checkbox({
						onChange: function () {
							changed.apply_open = true;
						}
					});
					
					new_tab.find(".goto-app-cent").click(function () {
						util.jump("#appcent/" + euid);
					});
					
					new_tab.find(".goto-termev").click(function () {
						util.jump("#termev/" + euid);
					});
				};

				if (is_self) {
					initDraft();

					function onChange(cb) {
						if (!hasDraft()) {
							return;
						}

						deleteEmptyDraft(function (empty) {
							if (!empty) {
								saveDraft(function (suc, deleted) {
									if (suc !== false) {
										if (!published && !deleted) {
											util.emsg("$front.sub.profile.save_draft", "info");
										}

										clearDraft();
									}

									cb(suc); // if suc == true, change the tab
								});
							} else {
								clearDraft();
								cb(true);
							}
						});

						return false;
					}

					tabs["draft"] = {
						order: 3,
						name: m("$front.sub.profile.draft").capital(),
						onShow: function (show) {
							tbar.setTitle("Profile", info.dname, "Draft");
							eventTabOnShow("draft", true, function (info) {
								loadDraft(info);
								tb.to("new");
							}, null, show);
						}
					};

					tabs["new"] = {
						order: 5,
						name: m("$front.sub.profile.new"),
						float: "right",
						style: "transparent icon-btn",

						onShow: function (show) {
							updateAllPos();

							tbar.setTitle("Profile", info.dname, "New");

							login.session(function (session) {
								if (hasDraft()) {
									updateAllPos();
									show();
								} else {
									// alert("hi");
									foci.encop(session, {
										int: "event",
										action: "new"
									}, function (suc, dat) {
										if (suc) {
											loadDraft({ euid: dat });
											updateAllPos();
											show();
										} else {
											util.emsg(dat);
										}
									});
								}
							});
						},

						onChange: onChange
					};
					
					login.session(function (session) {
						if (session.isAdmin()) {
							tabs["review"] = {
								order: 4,
								name: "Review",
								onShow: function (show) {
									tbar.setTitle("Profile", info.dname, "Review");
									eventTabOnShow("review", true, function (info) {
										loadDraft(info);
										tb.to("new");
									}, null, show);
								}
							};
						}
					});

					pt.jump(onChange);
				} else {
					(function () {
						var init = false;
						tabs["resume"] = {
							order: 0,
							name: m("$front.sub.profile.resume").capital(),
							onShow: function (show) {
								if (!init) {
									init = true;
									var	rtab = tb.getTab("resume");
									resume.init(rtab, uuid, { scroll: penv.part });
								}
								show();
							}
						}
					})();

					delete tabs["applied"];
				}

				var tb = tab.init(right_bar.find(".main-tab"), tabs);

				if (is_self) {
					tb.getTab("new").html(new_tab);
					tb.to("applied")
				} else {
					tb.to("resume");
				}

				// profile editable
				if (is_self) {
					main.addClass("logged");

					function setInfo(name, val) {
						var query = { int: "info", action: "set" };
						query[name] = val;

						login.session(function (session) {
							foci.encop(session, query, function (suc, dat) {
								if (suc) {
									info[name] = val;
									setDom(info);
								} else {
									util.emsg(dat);
								}
							});
						});
					}

					editable.init(left_bar.find(".dname"), function (text) {
						setInfo("dname", text);
					}, { text: function () { return info.dname; } });

					editable.init(left_bar.find(".intro"), function (text) {
						setInfo("intro", text);
					}, { text: function () { return info.intro; } });

					left_bar.find(".avatar").click(function () {
						upload.init(function (file) {
							if (file) {
								setInfo("avatar", file);
							}
						});
					});

					left_bar.find(".setting-btn").click(function () {
						util.jump("#setting/user");
						return;
						
						if (left_bar.find(".com-editable").hasClass("explicit")) {
							left_bar.find(".com-editable, .avatar").removeClass("explicit");
						} else {
							left_bar.find(".com-editable, .avatar").addClass("explicit");
						}

						$(this).find("i").toggleClass("setting checkmark");
					});
				}

				if (!is_self)
					left_bar.find(".chat-btn").click(function () {
						login.session(function (session) {
							pm.chatbox(uuid);
						});
					});

				var display_mode = "normal";

				function updateNewEventPos() {
					// console.log(new_tab.find(".ev-title").outerHeight(true));
					new_tab.find(".ev-descr")
						.css("box-sizing", "border-box")
						.css("height", tb.displayHeight() - new_tab.find(".ev-title").outerHeight(true) - 3 /* TODO: temporary fix!! */ + "px");

					editor_descr.refreshSize();

					new_tab.find(".ev-content .page")
						.css("height", tb.displayHeight() + "px");

					main.find(".right-bar-left-step").css("max-height", tb.displayHeight() + "px");
				}

				function updateAllPos() {
					if (!right_bar.offset().left) {
						display_mode = "mobile";
						right_bar.width(main.innerWidth());
						left_bar.css("height", "");
						tb.flow(true);
					} else {
						display_mode = "normal";
						right_bar.width(main.innerWidth() - left_bar.outerWidth());
						left_bar.css("height", main.innerHeight() + "px");
						tb.flow(false);
					}

					left_bar.css("min-height", main.height() + "px");

					updateNewEventPos();
				}

				$(window).resize(function () {
					updateAllPos();
				});

				main.ready(function () {
					$(window).resize();

					if (init_page && tb.has(init_page)) {
						if (init_page == "new" && page_arg && page_arg.length) {
							var euid = parseInt(page_arg[0]);

							if (isNaN(euid)) {
								util.emsg("$front.sub.event.illegal_euid");
							} else {
								login.session(function (session) {
									foci.encop(session, {
										int: "event",
										action: "info",
										euid: euid,
										state: foci.evstat.review
									}, function (suc, dat) {
										if (suc) {
											if (dat.org.indexOf(uuid) == -1) {
												loadDraft(dat, function () {
													if (page_arg[1]) {
														setDraftStep(page_arg[1]);
													}
												});

												tb.to("new");
											} else {
												util.jump("#profile");
											}
										} else {
											util.emsg(dat);
										}
									});
								});
							}
						} else {
							tb.to(init_page);
						}
					} else {
						if (!is_self)
							tip.init(main.find(".chat-btn"), "start chat here", "left center");
					}

					show(true); // show part
				});

				setDom(info);
			};

			if (args && args[0]) {
				var uuid = parseInt(args[0]);

				if (isNaN(uuid)) {
					util.emsg("$front.sub.profile.illegal_uuid");
					show(false);
				} else {
					foci.get("/user/info", { uuid: uuid }, function (suc, dat) {
						if (suc) {
							env.user(function (cur) {
								init(dat, cur && cur.uuid == dat.uuid, args[1]);
							});
						} else {
							util.emsg(dat);
							show(false);
						}
					});
				}
			} else {
				login.session(function (session) {
					if (session) {
						env.user(function (info) { init(info, true, args[1], args.slice(2)); });
					} else {
						show(false);
					}
				});
			}
		});
	}
</script>
