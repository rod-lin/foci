<!-- main portal -->
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Pragma" content="no-cache">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

		<script src="lib/foci.js"></script>
		<script src="lib/vcent.js"></script>
		<script src="lib/require.js"></script>

		<link rel="stylesheet" href="font/fontawesome/import.css">
		<link rel="stylesheet" href="font/ubuntu/import.css">
		<link rel="stylesheet" href="font/alegreya/import.css">

		<link rel="stylesheet" href="/semantic/semantic.min.css">
		<script src="/semantic/semantic.min.js"></script>

		<link rel="stylesheet" href="css/com.css">

		<!-- <link rel="stylesheet" href="com/tbar/import.css">
		<link rel="stylesheet" href="com/waterfall/import.css">
		<link rel="stylesheet" href="com/xfilt/import.css">
		<link rel="stylesheet" href="com/event/import.css"> -->

		<script src="https://api.map.baidu.com/api?v=2.0&ak=B4lBjPwv47t4CNlFiyY4siyy&s=1"></script>

		<style>
			body {
				font-family: Ubuntu;
				line-height: normal;
				overflow: hidden;

				background: white;
			}

			#main {
				position: relative;
				height: 100%;
				width: 100%;
			}

			#search, #part {
				position: absolute;

				top: 0;
				left: 0;

				width: 100%;
				height: 100%;

				overflow: auto;
				overflow-x: hidden;
			}

			#cover {
				position: fixed;
				left: 0;
				top: 0;
				height: 100%;
				width: 100%;

				overflow: auto;

				background-image: url("img/cover1.jpg");
				background-repeat: no-repeat;
				background-size: cover;
				background-position: 50% 50%;

				opacity: 1;

				transition: opacity 0.3s;
			}
		</style>
	</head>

	<body class="padding-tbar">
		<div id="main">
			<div id="part"></div>
			<div id="search">
				<!-- <div class="header">
					<div class="ui breadcrumb" style="margin-top: 20px;">
						<div class="active section"></div>
					</div>
				</div> -->
				<div id="search-cont"></div>
			</div>

			<div id="cover" style="opacity: 0;">
				<!-- <div style="width: 100%; padding-top: 30rem;">
					<div style="
						width: 100%;
						height: 100rem;
						background: white;
						box-shadow: 0 0 5rem rgba(0, 0, 0, 0.4);
					"></div>
				</div> -->
			</div>
		</div>

		<div id="main-loader" class="ui active large loader"></div>

		<!-- <div id="frame" style="height: 100px; width: 200px; background: white;"></div> -->

		<!-- <div class="frame", style="width: 100%; height: 100%; position: fixed; top: 0; left: 0; background: #FFF;"></div> -->

		<script>
			require([ "com/frame" ], function (frame) {
				// var fr = frame.init("#frame");
				// fr.open("main.html");
			});

			require([
				"com/tbar", "com/event", "com/env",
				"com/util", "com/pages", "com/parts",
				"com/lang", "com/formi", "com/pm",
				"com/userhunt"
			], function (tbar, event, env, util, pages, parts, lang, formi, pm, uh) {
				lang.loadDict("english", util);

				// var f = formi.modal({
				// 	"name": "Staff Register",
				// 	"block": [
				// 		{
				// 			"name": "Contact",
				// 			"field": [
				// 				[
				// 					{
				// 						"name": "First name",
				// 						"input": {
				// 							"type": "text",
				// 							"name": "first"
				// 						}
				// 					},
				// 					{
				// 						"name": "Last name",
				// 						"input": {
				// 							"type": "text",
				// 							"name": "last"
				// 						}
				// 					}
				// 				],

				// 				[ {
				// 					"name": "Last name",
				// 					"input": {
				// 						"type": "text",
				// 						"name": "last"
				// 					}
				// 				} ]
				// 			]
				// 		}
				// 	]
				// });

				// f.openEdit();

				// setTimeout(function () {
				// 	res = f.save();
				// 	formi.modal(res);
				// }, 5000);

				// uh.modal();

				var cover = [ "img/cover1.jpg", "img/cover2.jpg", "img/cover3.jpg" ].choose();
				$("#cover").css("background-image", "url(" + cover + ")");

				env.init(function () {
					// map.init();
					// console.log(lang.expand("hola"));

					var bar = tbar.init();

					bar.menu(function () {
						if (!window.location.hash) {
							pg.toggle("cover", "search");
						} else {
							util.jump("#");
						}
					});

					bar.profile(function () {
						util.jump("#profile");
					});

					util.scroll("#search, #part", function (n) {
						if (n > 0) {
							bar.showBanner();
						} else {
							bar.hideBanner();
						}
					});

					var cover_loaded = false;
					var pg = pages.init({
						"search": {
							page: "#search",
							onShow: function () {
								bar.setTitle("Search");
								bar.delSimple();
							}
						},
						
						"cover": {
							page: "#cover",
							onShow: function () {
								bar.setTitle("Foci");
								bar.setSimple();
							},

							onLoad: function (show) {
								if (cover_loaded) {
									show();
								} else {
									$("#cover").off("ready").ready(function () {
										setTimeout(function () {
											$("#main-loader").removeClass("active");
											show();
											cover_loaded = true;
										}, 2000);
									});
								}
							}
						},

						"part": {
							page: "#part",
							onShow: function () {
								bar.delSimple();
							}
						},
					}, { init: "cover" });

					var pt = parts.init("#part", {
						onJump: function (name, args) {
							bar.hideBanner();
							$("body").addClass("padding-tbar");

							// alert(args[0]);

							switch (name) {
								case "":
									pg.to("cover");
									break;

								case "search":
									$("#main-loader").removeClass("active");

									// format: #search/<kw>/tag1,tag2,tag3
									var query = { kw: "" };

									if (args[0]) {
										query.kw = args[0];
									}

									if (args[1]) {
										query.favtag = args[1].split(",");
									}

									// console.log(query);

									research(query);
									return true;

								default:
									bar.delSimple();
									$("#main-loader").removeClass("active");
									pg.to("part");
							}
						}
					});

					/* test */
					// pt.load("profile");
					// bar.delSimple();
					// pg.to("part");
					/* test */

					var ev = event.init("#search>#search-cont", {
						onUpdate: function (pos) {},
						fetch: {
							fetch: function (skip, sortby, cb) {
								foci.get("/event/search", $.extend({ skip: skip }, cur_query, sortby), cb);
							},

							cont: "#search",
							no_more_prompt: "no more results"
						},

						loader_only_on_buffer: true
					});

					env.store("tbar", bar);
					env.store("part", pt);

					bar.search(function (query, cb) {
						// research(query, cb);
						util.jump("#search/" + query.kw + "/" + (query.favtag ? query.favtag.join(",") : ""));
					});

					// re-search
					function research(query) {
						pg.to("search");
						bar.showSearchLoad();

						ev.clear(function () {
							bar.setTitle("Search results", query.kw);

							$("#search").scrollTop(0);
							cur_query = query;

							ev.hide();
							ev.fetch(function () {
								bar.hideSearchLoad();
								ev.show();
							});
						});
					}
				});
			});
		</script>
	</body>
</html>
