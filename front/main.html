<!-- main portal -->
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Pragma" content="no-cache">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

		<script src="lib/foci.js"></script>
		<script src="lib/vcent.js"></script>
		<script src="lib/require.js"></script>

		<link rel="stylesheet" href="font/fontawesome/import.css">
		<link rel="stylesheet" href="font/ubuntu/import.css">
		<link rel="stylesheet" href="font/brandon/import.css">
		<link rel="stylesheet" href="font/foci/import.css">

		<link rel="stylesheet" href="/semantic/semantic.min.css">
		<script src="/semantic/semantic.min.js"></script>

		<link rel="stylesheet" href="css/com.css">

		<!-- <link rel="stylesheet" href="com/tbar/import.css">
		<link rel="stylesheet" href="com/waterfall/import.css">
		<link rel="stylesheet" href="com/xfilt/import.css">
		<link rel="stylesheet" href="com/event/import.css"> -->

		<script src="https://api.map.baidu.com/api?v=2.0&ak=B4lBjPwv47t4CNlFiyY4siyy&s=1"></script>

		<style>
			body {
				font-family: Ubuntu;
				line-height: normal;
				overflow: hidden;

				background: rgba(255, 255, 255, 1);
			}

			#main {
				position: relative;
				height: 100%;
				width: 100%;
			}

			#search, #part {
				position: absolute;

				top: 0;
				left: 0;

				width: 100%;
				height: 100%;

				overflow: auto;
				overflow-x: hidden;
			}
		</style>
	</head>

	<body class="padding-tbar">
		<div id="main">
			<div id="part"></div>
			<div id="search">
				<!-- <div class="header">
					<div class="ui breadcrumb" style="margin-top: 20px;">
						<div class="active section"></div>
					</div>
				</div> -->
				<div id="search-cont"></div>
			</div>
		</div>

		<div id="main-loader" class="ui active large loader"></div>

		<!-- <div id="frame" style="height: 100px; width: 200px; background: white;"></div> -->

		<!-- <div class="frame", style="width: 100%; height: 100%; position: fixed; top: 0; left: 0; background: #FFF;"></div> -->

		<script>
			require([ "com/frame" ], function (frame) {
				// var fr = frame.init("#frame");
				// fr.open("main.html");
			});

			require([
				"com/tbar", "com/event", "com/env",
				"com/util", "com/pages", "com/parts",
				"com/lang", "com/formi", "com/pm",
				"com/map", "lib/fastclick"
			], function (tbar, event, env, util, pages, parts, lang, formi, pm, map, fastclick) {
				fastclick.attach(document.body);

				lang.loadDict("english", util, function () {
					lang.update(document.body);
				});

				// map.search();
				// uh.modal();

				// var cover = [ "img/cover1.jpg", "img/cover2.jpg", "img/cover3.jpg" ].choose();
				// $("#cover").css("background-image", "url(" + cover + ")");

				env.init(function () {
					// map.init();
					// console.log(lang.expand("hola"));

					var bar = tbar.init();

					bar.menu(function () {
						util.jump("#cover");
					});

					bar.profile(function () {
						util.jump("#profile");
					});

					// util.scrollTop("#search", function () {
					// 	bar.removeShadow();
					// });

					util.scroll("#search, #part", function (n) {
						if (n > 0) {
							bar.showBanner();
							// bar.applyShadow();
						} else {
							bar.hideBanner();
						}
					});

					// var cover_loaded = false;
					var pg = pages.init({
						"search": {
							page: "#search",
							onShow: function () {
								bar.setTitle("Search");
								bar.setStyle("shadowy");
							}
						},

						// "cover": {
						// 	page: "#cover",
						// 	onShow: function () {
						// 		bar.setTitle("Foci");
						// 		bar.setStyle("light-simple");
						// 	},

						// 	onLoad: function (show) {
						// 		if (cover_loaded) {
						// 			show();
						// 		} else {
						// 			$("#cover").off("ready").ready(function () {
						// 				setTimeout(function () {
						// 					$("#main-loader").removeClass("active");
						// 					show();
						// 					cover_loaded = true;
						// 				}, 2000);
						// 			});
						// 		}
						// 	}
						// },

						"part": {
							page: "#part",
							onShow: function () {
								bar.setStyle("");
							}
						},
					}, { init: "search" });

					var pt = parts.init("#part", {
						onJump: function (name, args) {
							bar.hideBanner();
							$("body").addClass("padding-tbar");

							// alert(args[0]);

							switch (name) {
								case "":
									util.jump("#cover");
									break;

								case "search":
									$("#main-loader").removeClass("active");

									// format: #search/<kw>/tag1,tag2,tag3
									var query = { kw: "" };

									if (args[0]) {
										query.kw = args[0];
									}

									if (args[1]) {
										query.favtag = args[1].split(",");
									}

									// console.log(query);

									research(query);
									return true;

								default:
									bar.setStyle("");
									$("#main-loader").removeClass("active");
									pg.to("part");
							}
						}
					});

					var ev = event.init("#search>#search-cont", {
						onUpdate: function (pos) {},
						fetch: {
							fetch: function (skip, sortby, cb) {
								foci.get("/event/search", $.extend({ skip: skip }, cur_query, sortby), cb);
							},

							cont: "#search",
							no_more_prompt: "no more results"
						},

						loader_only_on_buffer: true
					});

					env.store("tbar", bar);
					env.store("part", pt);

					bar.search(function (query, cb) {
						// research(query, cb);
						util.jump("#search/" + query.kw + "/" + (query.favtag ? query.favtag.join(",") : ""));
					});

					// re-search
					function research(query) {
						pg.to("search");
						bar.showSearchLoad();

						ev.clear(function () {
							bar.setTitle("Search results", (query.kw || "(empty)") + ", " + (query.favtag || "all"));

							$("#search").scrollTop(0);
							cur_query = query;

							ev.hide();
							ev.fetch(function () {
								bar.hideSearchLoad();
								ev.show();
							});
						});
					}
				});
			});
		</script>
	</body>
</html>
